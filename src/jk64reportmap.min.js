var reportmap={parseLatLng:function(e){var a,o;(apex.debug("reportmap.parseLatLng "+e),null!=e)&&(e.indexOf(";")>-1?o=e.split(";"):e.indexOf(" ")>-1?o=e.split(" "):e.indexOf(",")>-1&&(o=e.split(",")),o&&2==o.length?(o[0]=o[0].replace(/,/g,"."),o[1]=o[1].replace(/,/g,"."),apex.debug("parsed "+o[0]+" "+o[1]),a=new google.maps.LatLng(parseFloat(o[0]),parseFloat(o[1]))):apex.debug('no LatLng found in "'+e+'"'));return a},gotoAddress:function(e,a){apex.debug(e.regionId+" reportmap.gotoAddress"),(new google.maps.Geocoder).geocode({address:a,componentRestrictions:""!==e.country?{country:e.country}:{}},function(a,o){if(o===google.maps.GeocoderStatus.OK){var n=a[0].geometry.location;apex.debug(e.regionId+" geocode ok"),e.markerPan&&(e.map.setCenter(n),e.map.panTo(n)),e.markerZoom&&e.map.setZoom(e.markerZoom),reportmap.userPin(e,n.lat(),n.lng()),apex.debug(e.regionId+" addressfound '"+a[0].formatted_address+"'"),apex.jQuery("#"+e.regionId).trigger("addressfound",{map:e.map,lat:n.lat(),lng:n.lng(),result:a[0]})}else apex.debug(e.regionId+" geocode was unsuccessful for the following reason: "+o)})},repPin:function(e,a){var o=new google.maps.LatLng(a.lat,a.lng),n=new google.maps.Marker({map:e.map,position:o,title:a.name,icon:a.icon,label:a.label,draggable:e.isDraggable});return google.maps.event.addListener(n,"click",function(){apex.debug(e.regionId+" repPin "+a.id+" clicked"),a.info&&(e.iw?e.iw.close():e.iw=new google.maps.InfoWindow,e.iw.setOptions({content:a.info}),e.iw.open(e.map,this)),e.markerPan&&e.map.panTo(this.getPosition()),e.markerZoom&&e.map.setZoom(e.markerZoom),apex.jQuery("#"+e.regionId).trigger("markerclick",{map:e.map,id:a.id,name:a.name,lat:a.lat,lng:a.lng})}),google.maps.event.addListener(n,"dragend",function(){apex.debug(e.regionId+" repPin "+a.id+" moved to position ("+this.getPosition().lat()+","+this.getPosition().lng()+")"),apex.jQuery("#"+e.regionId).trigger("markerdrag",{map:e.map,id:a.id,name:a.name,lat:this.getPosition().lat(),lng:this.getPosition().lng()})}),e.reppin||(e.reppin=[]),e.reppin.push({id:a.id,marker:n}),n},repPins:function(e){if(apex.debug(e.regionId+" reportmap.repPins"),e.mapdata.length>0){e.infoNoDataFound&&(apex.debug(e.regionId+" hide No Data Found infowindow"),e.infoNoDataFound.close());for(var a,o=[],n=0;n<e.mapdata.length;n++)e.heatmap?o.push({location:new google.maps.LatLng(e.mapdata[n].a,e.mapdata[n].b),weight:e.mapdata[n].c}):(a=reportmap.repPin(e,e.mapdata[n]),e.markerClustering&&o.push(a));if(e.markerClustering)new MarkerClusterer(e.map,o,{imagePath:e.imagePrefix});else e.heatmap&&(e.heatmapLayer&&(apex.debug(e.regionId+" hide heatmapLayer"),e.heatmapLayer.setMap(null),apex.debug(e.regionId+" remove heatmapLayer"),e.heatmapLayer.delete,e.heatmapLayer=null),e.heatmapLayer=new google.maps.visualization.HeatmapLayer({data:o,map:e.map,dissipating:e.dissipating,opacity:e.opacity,radius:e.radius}))}else""!==e.noDataMessage&&(apex.debug(e.regionId+" show No Data Found infowindow"),e.infoNoDataFound?e.infoNoDataFound.close():e.infoNoDataFound=new google.maps.InfoWindow({content:e.noDataMessage,position:reportmap.parseLatLng(e.latlng)}),e.infoNoDataFound.open(e.map))},click:function(e,a){apex.debug(e.regionId+" reportmap.click");for(var o=!1,n=0;n<e.reppin.length;n++)if(e.reppin[n].id==a){new google.maps.event.trigger(e.reppin[n].marker,"click"),o=!0;break}o||apex.debug(e.regionId+" id not found:"+a)},gotoPosByString:function(e,a){apex.debug(e.regionId+" reportmap.gotoPos");var o=parseLatLng(a);o&&(apex.debug(e.regionId+" item changed "+o.lat()+" "+o.lng()),reportmap.userPin(e,o.lat(),o.lng()))},gotoPos:function(e,a,o){if(apex.debug(e.regionId+" reportmap.userPin"),null!==a&&null!==o){var n=e.userpin?e.userpin.getPosition():new google.maps.LatLng(0,0);if(n&&a==n.lat()&&o==n.lng())apex.debug(e.regionId+" userpin not changed");else{var t=new google.maps.LatLng(a,o);e.userpin?(apex.debug(e.regionId+" move existing pin to new position on map "+a+","+o),e.userpin.setMap(e.map),e.userpin.setPosition(t)):(apex.debug(e.regionId+" create userpin "+a+","+o),e.userpin=new google.maps.Marker({map:e.map,position:t,icon:e.icon}))}}else e.userpin&&(apex.debug(e.regionId+" move existing pin off the map"),e.userpin.setMap(null),e.distcircle&&(apex.debug(e.regionId+" move distcircle off the map"),e.distcircle.setMap(null)))},searchAddress:function(e,a,o){apex.debug(e.regionId+" reportmap.searchAddress");var n={lat:a,lng:o};(new google.maps.Geocoder).geocode({location:n},function(n,t){if(t===google.maps.GeocoderStatus.OK)if(n[0]){apex.debug(e.regionId+" addressfound '"+n[0].formatted_address+"'");var r=n[0].address_components;for(i=0;i<r.length;i++)apex.debug(e.regionId+" result[0] "+r[i].types+"="+r[i].short_name+" ("+r[i].long_name+")");apex.jQuery("#"+e.regionId).trigger("addressfound",{map:e.map,lat:a,lng:o,result:n[0]})}else apex.debug(e.regionId+" searchAddress: No results found"),window.alert("No results found");else apex.debug(e.regionId+" Geocoder failed due to: "+t),window.alert("Geocoder failed due to: "+t)})},geolocate:function(e){apex.debug(e.regionId+" reportmap.geolocate"),navigator.geolocation?(apex.debug(e.regionId+" geolocate"),navigator.geolocation.getCurrentPosition(function(a){var o={lat:a.coords.latitude,lng:a.coords.longitude};e.map.panTo(o),e.geolocateZoom&&e.map.setZoom(e.geolocateZoom),apex.jQuery("#"+e.regionId).trigger("geolocate",{map:e.map,lat:o.lat,lng:o.lng})})):apex.debug(e.regionId+" browser does not support geolocation")},directionsresp:function(e,a,o){if(apex.debug(o.regionId+" reportmap.directionsresp"),a==google.maps.DirectionsStatus.OK){o.directionsDisplay.setDirections(e);for(var n=0,t=0,r=0,i=0;i<e.routes.length;i++){r+=e.routes[i].legs.length;for(var p=0;p<e.routes[i].legs.length;p++){var g=e.routes[i].legs[p];n+=g.distance.value,t+=g.duration.value}}apex.jQuery("#"+o.regionId).trigger("directions",{map:o.map,distance:n,duration:t,legs:r})}else apex.debug(o.regionId+" Directions request failed due to "+a),window.alert("Directions request failed due to "+a)},directions:function(e){apex.debug(e.regionId+" reportmap.directions "+e.directions);var a,o,n,t=e.directions.indexOf("-ROUTE");if(t<0)a=$v(e.originItem),o=$v(e.destItem),a=reportmap.parseLatLng(a)||a,o=reportmap.parseLatLng(o)||o,""!==a&&""!==o&&(n=e.directions,e.directionsService.route({origin:a,destination:o,travelMode:google.maps.TravelMode[n]},function(a,o){reportmap.directionsresp(a,o,e)}));else{n=e.directions.slice(0,t),apex.debug(e.regionId+" route via "+n+" with "+e.mapdata.length+" waypoints");for(var r=[],i=0;i<e.mapdata.length;i++)0==i?a=new google.maps.LatLng(e.mapdata[i].lat,e.mapdata[i].lng):i==e.mapdata.length-1?o=new google.maps.LatLng(e.mapdata[i].lat,e.mapdata[i].lng):r.push({location:new google.maps.LatLng(e.mapdata[i].lat,e.mapdata[i].lng),stopover:!0});apex.debug(e.regionId+" origin="+a),apex.debug(e.regionId+" dest="+o),apex.debug(e.regionId+" waypoints:"+r.length),e.directionsService.route({origin:a,destination:o,waypoints:r,optimizeWaypoints:e.optimizeWaypoints,travelMode:google.maps.TravelMode[n]},function(a,o){reportmap.directionsresp(a,o,e)})}},init:function(e){apex.debug(e.regionId+" reportmap.init "+e.maptype);var a={zoom:1,center:reportmap.parseLatLng(e.latlng),mapTypeId:e.maptype},o=window.location.origin+window.location.pathname;o=o.substring(0,o.lastIndexOf("/")),e.imagePrefix=o+"/"+e.pluginFilePrefix+"images/m",apex.debug('opt.imagePrefix="'+e.imagePrefix+'"'),e.map=new google.maps.Map(document.getElementById(e.container),a),e.map.setOptions({draggable:e.pan,zoomControl:e.zoom,scrollwheel:e.zoom,disableDoubleClickZoom:!e.zoom,gestureHandling:e.gestureHandling}),e.mapstyle&&e.map.setOptions({styles:e.mapstyle}),e.map.fitBounds(new google.maps.LatLngBounds(e.southwest,e.northeast)),e.expectData&&reportmap.repPins(e),e.directions&&(e.directionsDisplay=new google.maps.DirectionsRenderer,e.directionsService=new google.maps.DirectionsService,e.directionsDisplay.setMap(e.map),reportmap.directions(e),e.directions.indexOf("-ROUTE")<0&&($("#"+e.originItem).change(function(){reportmap.directions(e)}),$("#"+e.destItem).change(function(){reportmap.directions(e)}))),google.maps.event.addListener(e.map,"click",function(a){var o=a.latLng.lat(),n=a.latLng.lng();apex.debug(e.regionId+" map clicked "+o+","+n),e.markerZoom&&(apex.debug(e.regionId+" pan+zoom"),e.markerPan&&e.map.panTo(a.latLng),e.map.setZoom(e.markerZoom)),apex.jQuery("#"+e.regionId).trigger("mapclick",{map:e.map,lat:o,lng:n})}),apex.debug(e.regionId+" reportmap.init finished"),apex.jQuery("#"+e.regionId).trigger("maploaded",{map:e.map})},refresh:function(e){apex.debug(e.regionId+" reportmap.refresh"),apex.jQuery("#"+e.regionId).trigger("apexbeforerefresh"),apex.server.plugin(e.ajaxIdentifier,{pageItems:e.ajaxItems},{dataType:"json",success:function(a){if(apex.debug(e.regionId+" success pData="+a.southwest.lat+","+a.southwest.lng+" "+a.northeast.lat+","+a.northeast.lng),e.map.fitBounds({south:a.southwest.lat,west:a.southwest.lng,north:a.northeast.lat,east:a.northeast.lng}),e.iw&&e.iw.close(),e.reppin){apex.debug(e.regionId+" remove all report pins");for(var o=0;o<e.reppin.length;o++)e.reppin[o].marker.setMap(null);e.reppin.delete}e.markers&&e.markers.delete,apex.debug(e.regionId+" pData.mapdata.length="+a.mapdata.length),e.mapdata=a.mapdata,e.expectData&&reportmap.repPins(e),apex.jQuery("#"+e.regionId).trigger("apexafterrefresh")}}),apex.debug(e.regionId+" reportmap.refresh finished")}};