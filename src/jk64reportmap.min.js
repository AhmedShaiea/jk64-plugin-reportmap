$(function(){$.widget("jk64.reportmap",{options:{regionId:"",ajaxIdentifier:"",ajaxItems:"",pluginFilePrefix:"",expectData:!0,visualisation:"pins",maptype:"",latlng:"",markerZoom:null,isDraggable:!1,dissipating:!1,opacity:.6,radius:5,panOnClick:!1,country:"",southwest:{lat:-60,lng:-180},northeast:{lat:70,lng:180},mapstyle:"",noDataMessage:"No data to show",directions:"",optimizeWaypoints:!1,originItem:"",destItem:"",zoom:!0,pan:!0,gestureHandling:"auto",parseLatLng:null,gotoPos:null,gotoPosByString:null,gotoAddress:null,click:null,searchAddress:null,geolocate:null},parseLatLng:function(e){var o,t;(apex.debug("reportmap.parseLatLng "+e),null!=e)&&(e.indexOf(";")>-1?t=e.split(";"):e.indexOf(" ")>-1?t=e.split(" "):e.indexOf(",")>-1&&(t=e.split(",")),t&&2==t.length?(t[0]=t[0].replace(/,/g,"."),t[1]=t[1].replace(/,/g,"."),apex.debug("parsed "+t[0]+" "+t[1]),o=new google.maps.LatLng(parseFloat(t[0]),parseFloat(t[1]))):apex.debug('no LatLng found in "'+e+'"'));return o},_repPin:function(e){var o=this,t=new google.maps.LatLng(e.lat,e.lng),a=new google.maps.Marker({map:o.map,position:t,title:e.name,icon:e.icon,label:e.label,draggable:o.options.isDraggable});return google.maps.event.addListener(a,"click",function(){apex.debug("repPin "+e.id+" clicked"),e.info&&(o.iw?o.iw.close():o.iw=new google.maps.InfoWindow,o.iw.setOptions({content:e.info}),o.iw.open(o.map,this)),o.options.panOnClick&&o.map.panTo(this.getPosition()),o.options.markerZoom&&o.map.setZoom(o.options.markerZoom),apex.jQuery("#"+o.options.regionId).trigger("markerclick",{map:o.map,id:e.id,name:e.name,lat:e.lat,lng:e.lng})}),google.maps.event.addListener(a,"dragend",function(){var t=this.getPosition();apex.debug("repPin "+e.id+" moved to position ("+t.lat()+","+t.lng()+")"),apex.jQuery("#"+o.options.regionId).trigger("markerdrag",{map:o.map,id:e.id,name:e.name,lat:t.lat(),lng:t.lng()})}),o.reppin||(o.reppin=[]),o.reppin.push({id:e.id,marker:a}),a},_repPins:function(){apex.debug("reportmap.repPins");if(this.mapdata)if(this.mapdata.length>0){this.infoNoDataFound&&(apex.debug("hide No Data Found infowindow"),this.infoNoDataFound.close());for(var e,o=[],t=0;t<this.mapdata.length;t++)"heatmap"==this.options.visualisation?o.push({location:new google.maps.LatLng(this.mapdata[t].a,this.mapdata[t].b),weight:this.mapdata[t].c}):(e=this._repPin(this.mapdata[t]),"cluster"==this.options.visualisation&&o.push(e));if("cluster"==this.options.visualisation)new MarkerClusterer(this.map,o,{imagePath:this.imagePrefix});else"heatmap"==this.options.visualisation&&(this.heatmapLayer&&(apex.debug("hide heatmapLayer"),this.heatmapLayer.setMap(null),apex.debug("remove heatmapLayer"),this.heatmapLayer.delete,this.heatmapLayer=null),this.heatmapLayer=new google.maps.visualization.HeatmapLayer({data:o,map:this.map,dissipating:this.options.dissipating,opacity:this.options.opacity,radius:this.options.radius}))}else""!==this.options.noDataMessage&&(apex.debug("show No Data Found infowindow"),this.infoNoDataFound?this.infoNoDataFound.close():this.infoNoDataFound=new google.maps.InfoWindow({content:this.options.noDataMessage,position:this.parseLatLng(this.options.latlng)}),this.infoNoDataFound.open(this.map))},_removePins:function(){apex.debug("reportmap._removePins");if(this.reppin){for(var e=0;e<this.reppin.length;e++)this.reppin[e].marker.setMap(null);this.reppin.delete}},gotoPos:function(e,o){apex.debug("reportmap.gotoPos");if(null!==e&&null!==o){var t=this.userpin?this.userpin.getPosition():new google.maps.LatLng(0,0);if(t&&e==t.lat()&&o==t.lng())apex.debug("userpin not changed");else{var a=new google.maps.LatLng(e,o);this.userpin?(apex.debug("move existing pin to new position on map "+e+","+o),this.userpin.setMap(this.map),this.userpin.setPosition(a)):(apex.debug("create userpin "+e+","+o),this.userpin=new google.maps.Marker({map:this.map,position:a}))}}else this.userpin&&(apex.debug("move existing pin off the map"),this.userpin.setMap(null))},gotoPosByString:function(e){apex.debug("reportmap.gotoPosByString");var o=this.parseLatLng(e);o&&(apex.debug("item changed "+o.lat()+" "+o.lng()),this.gotoPos(o.lat(),o.lng()))},gotoAddress:function(e){apex.debug("reportmap.gotoAddress");var o=this;(new google.maps.Geocoder).geocode({address:e,componentRestrictions:""!==o.options.country?{country:o.options.country}:{}},function(e,t){if(t===google.maps.GeocoderStatus.OK){var a=e[0].geometry.location;apex.debug("geocode ok"),o.map.setCenter(a),o.map.panTo(a),o.options.markerZoom&&o.map.setZoom(o.options.markerZoom),o.gotoPos(a.lat(),a.lng()),apex.debug("addressfound '"+e[0].formatted_address+"'"),apex.jQuery("#"+o.options.regionId).trigger("addressfound",{map:o.map,lat:a.lat(),lng:a.lng(),result:e[0]})}else apex.debug("geocode was unsuccessful for the following reason: "+t)})},click:function(e){apex.debug("reportmap.click");for(var o=!1,t=0;t<this.reppin.length;t++)if(this.reppin[t].id==e){new google.maps.event.trigger(this.reppin[t].marker,"click"),o=!0;break}o||apex.debug("id not found:"+e)},searchAddress:function(e,o){apex.debug("reportmap.searchAddress");var t=this,a={lat:e,lng:o};(new google.maps.Geocoder).geocode({location:a},function(a,n){if(n===google.maps.GeocoderStatus.OK)if(a[0]){apex.debug("addressfound '"+a[0].formatted_address+"'");var s=a[0].address_components;for(i=0;i<s.length;i++)apex.debug("result[0] "+s[i].types+"="+s[i].short_name+" ("+s[i].long_name+")");apex.jQuery("#"+t.options.regionId).trigger("addressfound",{map:t.map,lat:e,lng:o,result:a[0]})}else apex.debug("searchAddress: No results found"),window.alert("No results found");else apex.debug("Geocoder failed due to: "+n),window.alert("Geocoder failed due to: "+n)})},geolocate:function(){apex.debug("reportmap.geolocate");var e=this;navigator.geolocation?(apex.debug("geolocate"),navigator.geolocation.getCurrentPosition(function(o){var t={lat:o.coords.latitude,lng:o.coords.longitude};e.map.panTo(t),e.options.geolocateZoom&&e.map.setZoom(e.options.geolocateZoom),apex.jQuery("#"+e.options.regionId).trigger("geolocate",{map:e.map,lat:t.lat,lng:t.lng})})):apex.debug("browser does not support geolocation")},_directionsresp:function(e,o){apex.debug("reportmap._directionsresp");if(o==google.maps.DirectionsStatus.OK){this.directionsDisplay.setDirections(e);for(var t=0,a=0,i=0,n=0;n<e.routes.length;n++){i+=e.routes[n].legs.length;for(var s=0;s<e.routes[n].legs.length;s++){var p=e.routes[n].legs[s];t+=p.distance.value,a+=p.duration.value}}apex.jQuery("#"+this.options.regionId).trigger("directions",{map:this.map,distance:t,duration:a,legs:i})}else apex.debug("Directions request failed due to "+o),window.alert("Directions request failed due to "+o)},_directions:function(){apex.debug("reportmap._directions "+this.options.directions);var e,o,t,a=this,i=a.options.directions.indexOf("-ROUTE");if(i<0)e=$v(a.options.originItem),o=$v(a.options.destItem),e=a.parseLatLng(e)||e,o=a.parseLatLng(o)||o,""!==e&&""!==o&&(t=a.options.directions,a.directionsService.route({origin:e,destination:o,travelMode:google.maps.TravelMode[t]},function(e,o){a._directionsresp(e,o)}));else{t=a.options.directions.slice(0,i),apex.debug("route via "+t+" with "+a.mapdata.length+" waypoints");for(var n=[],s=0;s<a.mapdata.length;s++)0==s?e=new google.maps.LatLng(a.mapdata[s].lat,a.mapdata[s].lng):s==a.mapdata.length-1?o=new google.maps.LatLng(a.mapdata[s].lat,a.mapdata[s].lng):n.push({location:new google.maps.LatLng(a.mapdata[s].lat,a.mapdata[s].lng),stopover:!0});apex.debug("origin="+e+" dest="+o+" waypoints:"+n.length),a.directionsService.route({origin:e,destination:o,waypoints:n,optimizeWaypoints:this.options.optimizeWaypoints,travelMode:google.maps.TravelMode[t]},function(e,o){a._directionsresp(e,o)})}},_create:function(){apex.debug("reportmap._create "+this.element.prop("id"));var e=this,o={zoom:1,center:e.parseLatLng(e.options.latlng),mapTypeId:e.maptype},t=window.location.origin+window.location.pathname;t=t.substring(0,t.lastIndexOf("/")),e.imagePrefix=t+"/"+e.options.pluginFilePrefix+"images/m",apex.debug('_this.imagePrefix="'+e.imagePrefix+'"'),e.map=new google.maps.Map(document.getElementById(e.element.prop("id")),o),e.map.setOptions({draggable:e.options.pan,zoomControl:e.options.zoom,scrollwheel:e.options.zoom,disableDoubleClickZoom:!e.options.zoom,gestureHandling:e.options.gestureHandling}),e.mapstyle&&e.map.setOptions({styles:e.mapstyle}),e.map.fitBounds(new google.maps.LatLngBounds(e.options.southwest,e.options.northeast)),e.options.directions&&(e.directionsDisplay=new google.maps.DirectionsRenderer,e.directionsService=new google.maps.DirectionsService,e.directionsDisplay.setMap(e.map),e.options.directions.indexOf("-ROUTE")<0&&($("#"+e.options.originItem).change(function(){e._directions()}),$("#"+e.options.destItem).change(function(){e._directions()}))),google.maps.event.addListener(e.map,"click",function(o){var t=o.latLng.lat(),a=o.latLng.lng();apex.debug("map clicked "+t+","+a),e.options.markerZoom&&(apex.debug("pan+zoom"),e.options.panOnClick&&e.map.panTo(o.latLng),e.map.setZoom(e.options.markerZoom)),apex.jQuery("#"+e.options.regionId).trigger("mapclick",{map:e.map,lat:t,lng:a})}),apex.debug("reportmap.init finished"),apex.jQuery("#"+e.options.regionId).trigger("maploaded",{map:e.map}),e.options.expectData&&e._refresh()},_refresh:function(){apex.debug("reportmap._refresh");var e=this;e.options.expectData&&(apex.jQuery("#"+e.options.regionId).trigger("apexbeforerefresh"),apex.server.plugin(e.options.ajaxIdentifier,{pageItems:e.options.ajaxItems},{dataType:"json",success:function(o){apex.debug("success pData="+o.southwest.lat+","+o.southwest.lng+" "+o.northeast.lat+","+o.northeast.lng),e.map.fitBounds({south:o.southwest.lat,west:o.southwest.lng,north:o.northeast.lat,east:o.northeast.lng}),e.iw&&e.iw.close(),e._removePins(),apex.debug("pData.mapdata.length="+o.mapdata.length),e.mapdata=o.mapdata,e._repPins(),e.options.directions&&e._directions(),apex.jQuery("#"+e.options.regionId).trigger("apexafterrefresh")}})),apex.debug("reportmap._refresh finished"),e._trigger("change")},_destroy:function(){this.heatmapLayer&&this.heatmapLayer.remove(),this._removePins(),this.map.remove()},_setOptions:function(){this._superApply(arguments),this._refresh()},_setOption:function(e,o){this._super(e,o)}})});