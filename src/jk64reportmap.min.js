var reportmap={parseLatLng:function(e){var o,a;(apex.debug("reportmap.parseLatLng "+e),null!=e)&&(e.indexOf(";")>-1?a=e.split(";"):e.indexOf(" ")>-1?a=e.split(" "):e.indexOf(",")>-1&&(a=e.split(",")),a&&2==a.length?(a[0]=a[0].replace(/,/g,"."),a[1]=a[1].replace(/,/g,"."),apex.debug("parsed "+a[0]+" "+a[1]),o=new google.maps.LatLng(parseFloat(a[0]),parseFloat(a[1]))):apex.debug('no LatLng found in "'+e+'"'));return o},gotoAddress:function(e,o){apex.debug(e.regionId+" reportmap.gotoAddress"),(new google.maps.Geocoder).geocode({address:o,componentRestrictions:""!==e.country?{country:e.country}:{}},function(o,a){if(a===google.maps.GeocoderStatus.OK){var n=o[0].geometry.location;apex.debug(e.regionId+" geocode ok"),e.markerPan&&(e.map.setCenter(n),e.map.panTo(n)),e.markerZoom&&e.map.setZoom(e.markerZoom),reportmap.userPin(e,n.lat(),n.lng()),apex.debug(e.regionId+" addressfound '"+o[0].formatted_address+"'"),apex.jQuery("#"+e.regionId).trigger("addressfound",{map:e.map,lat:n.lat(),lng:n.lng(),result:o[0]})}else apex.debug(e.regionId+" geocode was unsuccessful for the following reason: "+a)})},markerclick:function(e,o){apex.debug(e.regionId+" reportmap.markerclick"),apex.jQuery("#"+e.regionId).trigger("markerclick",{map:e.map,id:o.id,name:o.name,lat:o.lat,lng:o.lng})},repPin:function(e,o){var a=new google.maps.LatLng(o.lat,o.lng),n=new google.maps.Marker({map:e.map,position:a,title:o.name,icon:o.icon,label:o.label});google.maps.event.addListener(n,"click",function(){apex.debug(e.regionId+" repPin clicked "+o.id),o.info&&(e.iw?e.iw.close():e.iw=new google.maps.InfoWindow,e.iw.setOptions({content:o.info}),e.iw.open(e.map,this)),e.markerPan&&e.map.panTo(this.getPosition()),e.markerZoom&&e.map.setZoom(e.markerZoom),reportmap.markerclick(e,o)}),e.reppin||(e.reppin=[]),e.reppin.push({id:o.id,marker:n})},repPins:function(e){if(apex.debug(e.regionId+" reportmap.repPins"),e.mapdata.length>0){e.infoNoDataFound&&(apex.debug(e.regionId+" hide No Data Found infowindow"),e.infoNoDataFound.close());for(var o=0;o<e.mapdata.length;o++)reportmap.repPin(e,e.mapdata[o])}else""!==e.noDataMessage&&(apex.debug(e.regionId+" show No Data Found infowindow"),e.infoNoDataFound?e.infoNoDataFound.close():e.infoNoDataFound=new google.maps.InfoWindow({content:e.noDataMessage,position:reportmap.parseLatLng(e.latlng)}),e.infoNoDataFound.open(e.map))},click:function(e,o){apex.debug(e.regionId+" reportmap.click");for(var a=!1,n=0;n<e.reppin.length;n++)if(e.reppin[n].id==o){new google.maps.event.trigger(e.reppin[n].marker,"click"),a=!0;break}a||apex.debug(e.regionId+" id not found:"+o)},gotoPosByString:function(e,o){apex.debug(e.regionId+" reportmap.gotoPos");var a=parseLatLng(o);a&&(apex.debug(e.regionId+" item changed "+a.lat()+" "+a.lng()),reportmap.userPin(e,a.lat(),a.lng()))},gotoPos:function(e,o,a){if(apex.debug(e.regionId+" reportmap.userPin"),null!==o&&null!==a){var n=e.userpin?e.userpin.getPosition():new google.maps.LatLng(0,0);if(n&&o==n.lat()&&a==n.lng())apex.debug(e.regionId+" userpin not changed");else{var r=new google.maps.LatLng(o,a);e.userpin?(apex.debug(e.regionId+" move existing pin to new position on map "+o+","+a),e.userpin.setMap(e.map),e.userpin.setPosition(r)):(apex.debug(e.regionId+" create userpin "+o+","+a),e.userpin=new google.maps.Marker({map:e.map,position:r,icon:e.icon}))}}else e.userpin&&(apex.debug(e.regionId+" move existing pin off the map"),e.userpin.setMap(null),e.distcircle&&(apex.debug(e.regionId+" move distcircle off the map"),e.distcircle.setMap(null)))},searchAddress:function(e,o,a){apex.debug(e.regionId+" reportmap.searchAddress");var n={lat:o,lng:a};(new google.maps.Geocoder).geocode({location:n},function(n,r){if(r===google.maps.GeocoderStatus.OK)if(n[0]){apex.debug(e.regionId+" addressfound '"+n[0].formatted_address+"'");var t=n[0].address_components;for(i=0;i<t.length;i++)apex.debug(e.regionId+" result[0] "+t[i].types+"="+t[i].short_name+" ("+t[i].long_name+")");apex.jQuery("#"+e.regionId).trigger("addressfound",{map:e.map,lat:o,lng:a,result:n[0]})}else apex.debug(e.regionId+" searchAddress: No results found"),window.alert("No results found");else apex.debug(e.regionId+" Geocoder failed due to: "+r),window.alert("Geocoder failed due to: "+r)})},geolocate:function(e){apex.debug(e.regionId+" reportmap.geolocate"),navigator.geolocation?(apex.debug(e.regionId+" geolocate"),navigator.geolocation.getCurrentPosition(function(o){var a={lat:o.coords.latitude,lng:o.coords.longitude};e.map.panTo(a),e.geolocateZoom&&e.map.setZoom(e.geolocateZoom),apex.jQuery("#"+e.regionId).trigger("geolocate",{map:e.map,lat:a.lat,lng:a.lng})})):apex.debug(e.regionId+" browser does not support geolocation")},directionsresp:function(e,o,a){if(apex.debug(a.regionId+" reportmap.directionsresp"),o==google.maps.DirectionsStatus.OK){a.directionsDisplay.setDirections(e);for(var n=0,r=0,t=0,i=0;i<e.routes.length;i++){t+=e.routes[i].legs.length;for(var p=0;p<e.routes[i].legs.length;p++){var g=e.routes[i].legs[p];n+=g.distance.value,r+=g.duration.value}}apex.jQuery("#"+a.regionId).trigger("directions",{map:a.map,distance:n,duration:r,legs:t})}else apex.debug(a.regionId+" Directions request failed due to "+o),window.alert("Directions request failed due to "+o)},directions:function(e){apex.debug(e.regionId+" reportmap.directions "+e.directions);var o,a,n,r=e.directions.indexOf("-ROUTE");if(r<0)o=$v(e.originItem),a=$v(e.destItem),o=reportmap.parseLatLng(o)||o,a=reportmap.parseLatLng(a)||a,""!==o&&""!==a&&(n=e.directions,e.directionsService.route({origin:o,destination:a,travelMode:google.maps.TravelMode[n]},function(o,a){reportmap.directionsresp(o,a,e)}));else{n=e.directions.slice(0,r),apex.debug(e.regionId+" route via "+n+" with "+e.mapdata.length+" waypoints");for(var t=[],i=0;i<e.mapdata.length;i++)0==i?o=new google.maps.LatLng(e.mapdata[i].lat,e.mapdata[i].lng):i==e.mapdata.length-1?a=new google.maps.LatLng(e.mapdata[i].lat,e.mapdata[i].lng):t.push({location:new google.maps.LatLng(e.mapdata[i].lat,e.mapdata[i].lng),stopover:!0});apex.debug(e.regionId+" origin="+o),apex.debug(e.regionId+" dest="+a),apex.debug(e.regionId+" waypoints:"+t.length),e.directionsService.route({origin:o,destination:a,waypoints:t,optimizeWaypoints:e.optimizeWaypoints,travelMode:google.maps.TravelMode[n]},function(o,a){reportmap.directionsresp(o,a,e)})}},init:function(e){apex.debug(e.regionId+" reportmap.init "+e.maptype);var o={zoom:1,center:reportmap.parseLatLng(e.latlng),mapTypeId:e.maptype};e.map=new google.maps.Map(document.getElementById(e.container),o),e.map.setOptions({draggable:e.pan,zoomControl:e.zoom,scrollwheel:e.zoom,disableDoubleClickZoom:!e.zoom,gestureHandling:e.gestureHandling}),e.mapstyle&&e.map.setOptions({styles:e.mapstyle}),e.map.fitBounds(new google.maps.LatLngBounds(e.southwest,e.northeast)),e.expectData&&reportmap.repPins(e),e.directions&&(e.directionsDisplay=new google.maps.DirectionsRenderer,e.directionsService=new google.maps.DirectionsService,e.directionsDisplay.setMap(e.map),reportmap.directions(e),e.directions.indexOf("-ROUTE")<0&&($("#"+e.originItem).change(function(){reportmap.directions(e)}),$("#"+e.destItem).change(function(){reportmap.directions(e)}))),google.maps.event.addListener(e.map,"click",function(o){var a=o.latLng.lat(),n=o.latLng.lng();apex.debug(e.regionId+" map clicked "+a+","+n),e.markerZoom&&(apex.debug(e.regionId+" pan+zoom"),e.markerPan&&e.map.panTo(o.latLng),e.map.setZoom(e.markerZoom)),apex.jQuery("#"+e.regionId).trigger("mapclick",{map:e.map,lat:a,lng:n})}),apex.debug(e.regionId+" reportmap.init finished"),apex.jQuery("#"+e.regionId).trigger("maploaded",{map:e.map})},refresh:function(e){apex.debug(e.regionId+" reportmap.refresh"),apex.jQuery("#"+e.regionId).trigger("apexbeforerefresh"),apex.server.plugin(e.ajaxIdentifier,{pageItems:e.ajaxItems},{dataType:"json",success:function(o){if(apex.debug(e.regionId+" success pData="+o.southwest.lat+","+o.southwest.lng+" "+o.northeast.lat+","+o.northeast.lng),e.map.fitBounds({south:o.southwest.lat,west:o.southwest.lng,north:o.northeast.lat,east:o.northeast.lng}),e.iw&&e.iw.close(),e.reppin){apex.debug(e.regionId+" remove all report pins");for(var a=0;a<e.reppin.length;a++)e.reppin[a].marker.setMap(null);e.reppin.delete}apex.debug(e.regionId+" pData.mapdata.length="+o.mapdata.length),e.mapdata=o.mapdata,e.expectData&&reportmap.repPins(e),apex.jQuery("#"+e.regionId).trigger("apexafterrefresh")}}),apex.debug(e.regionId+" reportmap.refresh finished")}};