function jk64reportmap_geocode(e,t){t.geocode({address:$v(e.geocodeItem),componentRestrictions:""!==e.country?{country:e.country}:{}},function(t,a){if(a===google.maps.GeocoderStatus.OK){var r=t[0].geometry.location;apex.debug(e.regionId+" geocode ok"),e.map.setCenter(r),e.map.panTo(r),e.markerZoom&&e.map.setZoom(e.markerZoom),jk64reportmap_userPin(e,r.lat(),r.lng()),e.addressItem&&$s(e.addressItem,t[0].formatted_address),apex.debug(e.regionId+" addressfound '"+t[0].formatted_address+"'"),apex.jQuery("#"+e.regionId).trigger("addressfound",{map:e.map,lat:r.lat(),lng:r.lng(),formatted_address:t[0].formatted_address})}else apex.debug(e.regionId+" geocode was unsuccessful for the following reason: "+a)})}function jk64reportmap_markerclick(e,t){""!==e.idItem&&$s(e.idItem,t.id),apex.jQuery("#"+e.regionId).trigger("markerclick",{map:e.map,id:t.id,name:t.name,lat:t.lat,lng:t.lng,rad:t.rad,attr01:t.attr01,attr02:t.attr02,attr03:t.attr03,attr04:t.attr04,attr05:t.attr05,attr06:t.attr06,attr07:t.attr07,attr08:t.attr08,attr09:t.attr09,attr10:t.attr10})}function jk64reportmap_repPin(e,t){var a=new google.maps.LatLng(t.lat,t.lng);if(t.rad){var r=new google.maps.Circle({strokeColor:t.col,strokeOpacity:1,strokeWeight:1,fillColor:t.col,fillOpacity:t.trns,clickable:!0,map:e.map,center:a,radius:1e3*t.rad});google.maps.event.addListener(r,"click",function(){apex.debug(e.regionId+" circle clicked "+t.id),jk64reportmap_markerclick(e,t)}),e.circles||(e.circles=[]),e.circles.push({id:t.id,circ:r})}else{var o=new google.maps.Marker({map:e.map,position:a,title:t.name,icon:t.icon,label:t.label});google.maps.event.addListener(o,"click",function(){apex.debug(e.regionId+" repPin clicked "+t.id),t.info&&(e.iw?e.iw.close():e.iw=new google.maps.InfoWindow,e.iw.setOptions({content:t.info}),e.iw.open(e.map,this)),e.map.panTo(this.getPosition()),e.markerZoom&&e.map.setZoom(e.markerZoom),jk64reportmap_markerclick(e,t)}),e.reppin||(e.reppin=[]),e.reppin.push({id:t.id,marker:o})}}function jk64reportmap_repPins(e){if(e.mapdata.length>0){e.infoNoDataFound&&(apex.debug(e.regionId+" hide No Data Found infowindow"),e.infoNoDataFound.close());for(var t=0;t<e.mapdata.length;t++)jk64reportmap_repPin(e,e.mapdata[t])}else""!==e.noDataMessage&&(apex.debug(e.regionId+" show No Data Found infowindow"),e.infoNoDataFound?e.infoNoDataFound.close():e.infoNoDataFound=new google.maps.InfoWindow({content:e.noDataMessage,position:{lat:0,lng:0}}),e.infoNoDataFound.open(e.map))}function jk64reportmap_click(e,t){for(var a=!1,r=0;r<e.reppin.length;r++)if(e.reppin[r].id==t){new google.maps.event.trigger(e.reppin[r].marker,"click"),a=!0;break}a||apex.debug(e.regionId+" id not found:"+t)}function jk64reportmap_setCircle(e,t){if(""!==e.distItem)if(e.distcircle)apex.debug(e.regionId+" move circle"),e.distcircle.setCenter(t),e.distcircle.setMap(e.map);else{var a=parseFloat($v(e.distItem));apex.debug(e.regionId+" create circle radius="+a),e.distcircle=new google.maps.Circle({strokeColor:"#5050FF",strokeOpacity:.5,strokeWeight:2,fillColor:"#0000FF",fillOpacity:.05,clickable:!1,editable:!0,map:e.map,center:t,radius:1e3*a}),google.maps.event.addListener(e.distcircle,"radius_changed",function(t){var a=e.distcircle.getRadius()/1e3;apex.debug(e.regionId+" circle radius changed "+a),$s(e.distItem,a),jk64reportmap_refreshMap(e)}),google.maps.event.addListener(e.distcircle,"center_changed",function(t){var a=e.distcircle.getCenter(),r=a.lat()+","+a.lng();apex.debug(e.regionId+" circle center changed "+r),""!==e.syncItem&&($s(e.syncItem,r),jk64reportmap_refreshMap(e))})}}function jk64reportmap_userPin(e,t,a){if(null!==t&&null!==a){var r=e.userpin?e.userpin.getPosition():new google.maps.LatLng(0,0);if(t==r.lat()&&a==r.lng())apex.debug(e.regionId+" userpin not changed");else{var o=new google.maps.LatLng(t,a);e.userpin?(apex.debug(e.regionId+" move existing pin to new position on map "+t+","+a),e.userpin.setMap(e.map),e.userpin.setPosition(o),jk64reportmap_setCircle(e,o)):(apex.debug(e.regionId+" create userpin "+t+","+a),e.userpin=new google.maps.Marker({map:e.map,position:o,icon:e.icon}),jk64reportmap_setCircle(e,o))}}else e.userpin&&(apex.debug(e.regionId+" move existing pin off the map"),e.userpin.setMap(null),e.distcircle&&(apex.debug(e.regionId+" move distcircle off the map"),e.distcircle.setMap(null)))}function jk64reportmap_getAddress(e,t,a){var r={lat:t,lng:a};e.geocoder.geocode({location:r},function(r,o){o===google.maps.GeocoderStatus.OK?r[1]?($s(e.addressItem,r[0].formatted_address),apex.debug(e.regionId+" addressfound '"+r[0].formatted_address+"'"),apex.jQuery("#"+e.regionId).trigger("addressfound",{map:e.map,lat:t,lng:a,formatted_address:r[0].formatted_address})):window.alert("No results found"):window.alert("Geocoder failed due to: "+o)})}function jk64reportmap_geolocate(e){navigator.geolocation?(apex.debug(e.regionId+" geolocate"),navigator.geolocation.getCurrentPosition(function(t){var a={lat:t.coords.latitude,lng:t.coords.longitude};e.map.panTo(a),e.geolocateZoom&&e.map.setZoom(e.geolocateZoom),apex.jQuery("#"+e.regionId).trigger("geolocate",{map:e.map,lat:a.lat,lng:a.lng})})):apex.debug(e.regionId+" browser does not support geolocation")}function jk64reportmap_convertLatLng(e){var t=e.split(",");return 2!=t.length||isNaN(t[0])||isNaN(t[1])?e:{lat:parseFloat(t[0]),lng:parseFloat(t[1])}}function jk64reportmap_directionsresp(e,t,a){if(t==google.maps.DirectionsStatus.OK){if(a.directionsDisplay.setDirections(e),""!==a.dirdistItem||""!==a.dirdurItem){for(var r=0,o=0,i=0;i<e.routes.length;i++)for(var n=0;n<e.routes[i].legs.length;n++){var s=e.routes[i].legs[n];r+=s.distance.value,o+=s.duration.value}""!==a.dirdistItem&&$s(a.dirdistItem,r),""!==a.dirdurItem&&$s(a.dirdurItem,o)}}else window.alert("Directions request failed due to "+t)}function jk64reportmap_directions(e){apex.debug(e.regionId+" directions "+e.directions);var t,a,r,o=e.directions.indexOf("-ROUTE");if(0>o)t=jk64reportmap_convertLatLng($v(e.originItem)),a=jk64reportmap_convertLatLng($v(e.destItem)),""!==t&&""!==a&&(r=e.directions,e.directionsService.route({origin:t,destination:a,travelMode:google.maps.TravelMode[r]},function(t,a){jk64reportmap_directionsresp(t,a,e)}));else{r=e.directions.slice(0,o),apex.debug(e.regionId+" route via "+r+" with "+e.mapdata.length+" waypoints");for(var i=[],n=0;n<e.mapdata.length;n++)0==n?t=new google.maps.LatLng(e.mapdata[n].lat,e.mapdata[n].lng):n==e.mapdata.length-1?a=new google.maps.LatLng(e.mapdata[n].lat,e.mapdata[n].lng):i.push({location:new google.maps.LatLng(e.mapdata[n].lat,e.mapdata[n].lng),stopover:!0});apex.debug(e.regionId+" origin="+t),apex.debug(e.regionId+" dest="+a),apex.debug(e.regionId+" waypoints:"+i.length),e.directionsService.route({origin:t,destination:a,waypoints:i,optimizeWaypoints:e.optimizeWaypoints,travelMode:google.maps.TravelMode[r]},function(t,a){jk64reportmap_directionsresp(t,a,e)})}}function jk64reportmap_initMap(e){apex.debug(e.regionId+" initMap "+e.maptype);var t={zoom:1,center:new google.maps.LatLng(e.latlng),mapTypeId:e.maptype};if(e.map=new google.maps.Map(document.getElementById(e.container),t),e.mapstyle&&e.map.setOptions({styles:e.mapstyle}),e.map.fitBounds(new google.maps.LatLngBounds(e.southwest,e.northeast)),""!==e.syncItem){var a=$v(e.syncItem);if(null!==a&&a.indexOf(",")>-1){var r=a.split(",");apex.debug(e.regionId+" init from item "+a);var o=new google.maps.LatLng(r[0],r[1]);e.userpin=new google.maps.Marker({map:e.map,position:o,icon:e.icon}),jk64reportmap_setCircle(e,o)}$("#"+e.syncItem).change(function(){var t=this.value;if(null!==t&&void 0!==t&&t.indexOf(",")>-1){apex.debug(e.regionId+" item changed "+t);var a=t.split(",");jk64reportmap_userPin(e,a[0],a[1])}})}if(""!=e.distItem&&$("#"+e.distItem).change(function(){if(this.value){var t=1e3*parseFloat(this.value);e.distcircle.getRadius()!==t&&(apex.debug(e.regionId+" distitem changed "+this.value),e.distcircle.setRadius(t))}else e.distcircle&&(apex.debug(e.regionId+" distitem cleared"),e.distcircle.setMap(null))}),e.expectData&&jk64reportmap_repPins(e),""!==e.addressItem&&(e.geocoder=new google.maps.Geocoder),e.directions&&(e.directionsDisplay=new google.maps.DirectionsRenderer,e.directionsService=new google.maps.DirectionsService,e.directionsDisplay.setMap(e.map),jk64reportmap_directions(e),e.directions.indexOf("-ROUTE")<0&&($("#"+e.originItem).change(function(){jk64reportmap_directions(e)}),$("#"+e.destItem).change(function(){jk64reportmap_directions(e)}))),google.maps.event.addListener(e.map,"click",function(t){var a=t.latLng.lat(),r=t.latLng.lng();apex.debug(e.regionId+" map clicked "+a+","+r),(""!==e.syncItem||""!==e.addressItem)&&jk64reportmap_userPin(e,a,r),""!==e.syncItem?($s(e.syncItem,a+","+r),jk64reportmap_refreshMap(e)):e.markerZoom&&(apex.debug(e.regionId+" pan+zoom"),e.map.panTo(t.latLng),e.map.setZoom(e.markerZoom)),""!==e.addressItem&&jk64reportmap_getAddress(e,a,r),apex.jQuery("#"+e.regionId).trigger("mapclick",{map:e.map,lat:a,lng:r})}),""!=e.geocodeItem){var i=new google.maps.Geocoder;$("#"+e.geocodeItem).change(function(){jk64reportmap_geocode(e,i)})}e.geolocate&&jk64reportmap_geolocate(e),apex.debug(e.regionId+" initMap finished"),apex.jQuery("#"+e.regionId).trigger("maploaded",{map:e.map})}function jk64reportmap_refreshMap(e){apex.debug(e.regionId+" refreshMap"),apex.jQuery("#"+e.regionId).trigger("apexbeforerefresh"),apex.server.plugin(e.ajaxIdentifier,{pageItems:e.ajaxItems},{dataType:"json",success:function(t){if(apex.debug(e.regionId+" success pData="+t.southwest.lat+","+t.southwest.lng+" "+t.northeast.lat+","+t.northeast.lng),e.map.fitBounds({south:t.southwest.lat,west:t.southwest.lng,north:t.northeast.lat,east:t.northeast.lng}),e.iw&&e.iw.close(),e.reppin){apex.debug(e.regionId+" remove all report pins");for(var a=0;a<e.reppin.length;a++)e.reppin[a].marker.setMap(null);e.reppin["delete"]}if(e.circles){apex.debug(e.regionId+" remove all circles");for(var a=0;a<e.circles.length;a++)e.circles[a].circ.setMap(null);e.circles["delete"]}if(apex.debug(e.regionId+" pData.mapdata.length="+t.mapdata.length),e.mapdata=t.mapdata,e.expectData&&jk64reportmap_repPins(e),""!==e.syncItem){var r=$v(e.syncItem);if(null!==r&&r.indexOf(",")>-1){var o=r.split(",");apex.debug(e.regionId+" init from item "+r),jk64reportmap_userPin(e,o[0],o[1])}}apex.jQuery("#"+e.regionId).trigger("apexafterrefresh")}}),apex.debug(e.regionId+" refreshMap finished")}