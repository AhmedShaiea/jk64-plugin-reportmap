function jk64reportmap_parseLatLng(e){var a;if(apex.debug("jk64reportmap_parseLatLng "+e),null!=e&&e.indexOf(",")>-1){var t=e.split(",");apex.debug("parsed "+t[0]+" "+t[1]),a=new google.maps.LatLng(t[0],t[1])}return a}function jk64reportmap_geocode(e,a){a.geocode({address:$v(e.geocodeItem),componentRestrictions:""!==e.country?{country:e.country}:{}},function(a,t){if(t===google.maps.GeocoderStatus.OK){var r=a[0].geometry.location;apex.debug(e.regionId+" geocode ok"),e.markerPan&&(e.map.setCenter(r),e.map.panTo(r)),e.markerZoom&&e.map.setZoom(e.markerZoom),jk64reportmap_userPin(e,r.lat(),r.lng()),e.addressItem&&$s(e.addressItem,a[0].formatted_address),apex.debug(e.regionId+" addressfound '"+a[0].formatted_address+"'"),apex.jQuery("#"+e.regionId).trigger("addressfound",{map:e.map,lat:r.lat(),lng:r.lng(),formatted_address:a[0].formatted_address})}else apex.debug(e.regionId+" geocode was unsuccessful for the following reason: "+t)})}function jk64reportmap_markerclick(e,a){""!==e.idItem&&$s(e.idItem,a.id),apex.jQuery("#"+e.regionId).trigger("markerclick",{map:e.map,id:a.id,name:a.name,lat:a.lat,lng:a.lng,rad:a.rad,attr01:a.attr01,attr02:a.attr02,attr03:a.attr03,attr04:a.attr04,attr05:a.attr05,attr06:a.attr06,attr07:a.attr07,attr08:a.attr08,attr09:a.attr09,attr10:a.attr10})}function jk64reportmap_repPin(e,a){var t=new google.maps.LatLng(a.lat,a.lng);if(a.rad){var r=new google.maps.Circle({strokeColor:a.col,strokeOpacity:1,strokeWeight:1,fillColor:a.col,fillOpacity:a.trns,clickable:!0,map:e.map,center:t,radius:1e3*a.rad});google.maps.event.addListener(r,"click",function(){apex.debug(e.regionId+" circle clicked "+a.id),jk64reportmap_markerclick(e,a)}),e.circles||(e.circles=[]),e.circles.push({id:a.id,circ:r})}else{var o=new google.maps.Marker({map:e.map,position:t,title:a.name,icon:a.icon,label:a.label});google.maps.event.addListener(o,"click",function(){apex.debug(e.regionId+" repPin clicked "+a.id),a.info&&(e.iw?e.iw.close():e.iw=new google.maps.InfoWindow,e.iw.setOptions({content:a.info}),e.iw.open(e.map,this)),e.markerPan&&e.map.panTo(this.getPosition()),e.markerZoom&&e.map.setZoom(e.markerZoom),jk64reportmap_markerclick(e,a)}),e.reppin||(e.reppin=[]),e.reppin.push({id:a.id,marker:o})}}function jk64reportmap_repPins(e){if(e.mapdata.length>0){e.infoNoDataFound&&(apex.debug(e.regionId+" hide No Data Found infowindow"),e.infoNoDataFound.close());for(var a=0;a<e.mapdata.length;a++)jk64reportmap_repPin(e,e.mapdata[a])}else""!==e.noDataMessage&&(apex.debug(e.regionId+" show No Data Found infowindow"),e.infoNoDataFound?e.infoNoDataFound.close():e.infoNoDataFound=new google.maps.InfoWindow({content:e.noDataMessage,position:jk64reportmap_parseLatLng(e.latlng)}),e.infoNoDataFound.open(e.map))}function jk64reportmap_click(e,a){for(var t=!1,r=0;r<e.reppin.length;r++)if(e.reppin[r].id==a){new google.maps.event.trigger(e.reppin[r].marker,"click"),t=!0;break}t||apex.debug(e.regionId+" id not found:"+a)}function jk64reportmap_setCircle(e,a){if(""!==e.distItem)if(e.distcircle)apex.debug(e.regionId+" move circle"),e.distcircle.setCenter(a),e.distcircle.setMap(e.map);else{var t=parseFloat($v(e.distItem));apex.debug(e.regionId+" create circle radius="+t),e.distcircle=new google.maps.Circle({strokeColor:"#5050FF",strokeOpacity:.5,strokeWeight:2,fillColor:"#0000FF",fillOpacity:.05,clickable:!1,editable:!0,map:e.map,center:a,radius:1e3*t}),google.maps.event.addListener(e.distcircle,"radius_changed",function(a){var t=e.distcircle.getRadius()/1e3;apex.debug(e.regionId+" circle radius changed "+t),$s(e.distItem,t),jk64reportmap_refreshMap(e)}),google.maps.event.addListener(e.distcircle,"center_changed",function(a){var t=e.distcircle.getCenter(),r=t.lat()+","+t.lng();apex.debug(e.regionId+" circle center changed "+r),""!==e.syncItem&&($s(e.syncItem,r),jk64reportmap_refreshMap(e))})}}function jk64reportmap_userPin(e,a,t){if(null!==a&&null!==t){var r=e.userpin?e.userpin.getPosition():new google.maps.LatLng(0,0);if(a==r.lat()&&t==r.lng())apex.debug(e.regionId+" userpin not changed");else{var o=new google.maps.LatLng(a,t);e.userpin?(apex.debug(e.regionId+" move existing pin to new position on map "+a+","+t),e.userpin.setMap(e.map),e.userpin.setPosition(o),jk64reportmap_setCircle(e,o)):(apex.debug(e.regionId+" create userpin "+a+","+t),e.userpin=new google.maps.Marker({map:e.map,position:o,icon:e.icon}),jk64reportmap_setCircle(e,o))}}else e.userpin&&(apex.debug(e.regionId+" move existing pin off the map"),e.userpin.setMap(null),e.distcircle&&(apex.debug(e.regionId+" move distcircle off the map"),e.distcircle.setMap(null)))}function jk64reportmap_getAddress(e,a,t){var r={lat:a,lng:t};e.geocoder.geocode({location:r},function(r,o){o===google.maps.GeocoderStatus.OK?r[1]?($s(e.addressItem,r[0].formatted_address),apex.debug(e.regionId+" addressfound '"+r[0].formatted_address+"'"),apex.jQuery("#"+e.regionId).trigger("addressfound",{map:e.map,lat:a,lng:t,formatted_address:r[0].formatted_address})):window.alert("No results found"):window.alert("Geocoder failed due to: "+o)})}function jk64reportmap_geolocate(e){navigator.geolocation?(apex.debug(e.regionId+" geolocate"),navigator.geolocation.getCurrentPosition(function(a){var t={lat:a.coords.latitude,lng:a.coords.longitude};e.map.panTo(t),e.geolocateZoom&&e.map.setZoom(e.geolocateZoom),apex.jQuery("#"+e.regionId).trigger("geolocate",{map:e.map,lat:t.lat,lng:t.lng})})):apex.debug(e.regionId+" browser does not support geolocation")}function jk64reportmap_convertLatLng(e){var a=e.split(",");return 2!=a.length||isNaN(a[0])||isNaN(a[1])?e:{lat:parseFloat(a[0]),lng:parseFloat(a[1])}}function jk64reportmap_directionsresp(e,a,t){if(a==google.maps.DirectionsStatus.OK){if(t.directionsDisplay.setDirections(e),""!==t.dirdistItem||""!==t.dirdurItem){for(var r=0,o=0,i=0;i<e.routes.length;i++)for(var n=0;n<e.routes[i].legs.length;n++){var p=e.routes[i].legs[n];r+=p.distance.value,o+=p.duration.value}""!==t.dirdistItem&&$s(t.dirdistItem,r),""!==t.dirdurItem&&$s(t.dirdurItem,o)}}else window.alert("Directions request failed due to "+a)}function jk64reportmap_directions(e){apex.debug(e.regionId+" directions "+e.directions);var a,t,r,o=e.directions.indexOf("-ROUTE");if(o<0)a=jk64reportmap_convertLatLng($v(e.originItem)),t=jk64reportmap_convertLatLng($v(e.destItem)),""!==a&&""!==t&&(r=e.directions,e.directionsService.route({origin:a,destination:t,travelMode:google.maps.TravelMode[r]},function(a,t){jk64reportmap_directionsresp(a,t,e)}));else{r=e.directions.slice(0,o),apex.debug(e.regionId+" route via "+r+" with "+e.mapdata.length+" waypoints");for(var i=[],n=0;n<e.mapdata.length;n++)0==n?a=new google.maps.LatLng(e.mapdata[n].lat,e.mapdata[n].lng):n==e.mapdata.length-1?t=new google.maps.LatLng(e.mapdata[n].lat,e.mapdata[n].lng):i.push({location:new google.maps.LatLng(e.mapdata[n].lat,e.mapdata[n].lng),stopover:!0});apex.debug(e.regionId+" origin="+a),apex.debug(e.regionId+" dest="+t),apex.debug(e.regionId+" waypoints:"+i.length),e.directionsService.route({origin:a,destination:t,waypoints:i,optimizeWaypoints:e.optimizeWaypoints,travelMode:google.maps.TravelMode[r]},function(a,t){jk64reportmap_directionsresp(a,t,e)})}}function jk64reportmap_initMap(e){apex.debug(e.regionId+" initMap "+e.maptype);var a={zoom:1,center:jk64reportmap_parseLatLng(e.latlng),mapTypeId:e.maptype};if(e.map=new google.maps.Map(document.getElementById(e.container),a),e.map.setOptions({draggable:e.pan,zoomControl:e.zoom,scrollwheel:e.zoom,disableDoubleClickZoom:!e.zoom,gestureHandling:e.gestureHandling}),e.mapstyle&&e.map.setOptions({styles:e.mapstyle}),e.map.fitBounds(new google.maps.LatLngBounds(e.southwest,e.northeast)),""!==e.syncItem){var t=$v(e.syncItem);null!==t&&(e.userpin=new google.maps.Marker({map:e.map,position:jk64reportmap_parseLatLng(t),icon:e.icon}),jk64reportmap_setCircle(e,pos)),$("#"+e.syncItem).change(function(){var a=this.value;if(null!=a&&a.indexOf(",")>-1){var t=a.split(",");apex.debug(e.regionId+" item changed "+t[0]+" "+t[1]),jk64reportmap_userPin(e,t[0],t[1])}})}if(""!=e.distItem&&$("#"+e.distItem).change(function(){if(this.value){var a=1e3*parseFloat(this.value);e.distcircle.getRadius()!==a&&(apex.debug(e.regionId+" distitem changed "+a),e.distcircle.setRadius(a))}else e.distcircle&&(apex.debug(e.regionId+" distitem cleared"),e.distcircle.setMap(null))}),e.expectData&&jk64reportmap_repPins(e),""!==e.addressItem&&(e.geocoder=new google.maps.Geocoder),e.directions&&(e.directionsDisplay=new google.maps.DirectionsRenderer,e.directionsService=new google.maps.DirectionsService,e.directionsDisplay.setMap(e.map),jk64reportmap_directions(e),e.directions.indexOf("-ROUTE")<0&&($("#"+e.originItem).change(function(){jk64reportmap_directions(e)}),$("#"+e.destItem).change(function(){jk64reportmap_directions(e)}))),google.maps.event.addListener(e.map,"click",function(a){var t=a.latLng.lat(),r=a.latLng.lng();apex.debug(e.regionId+" map clicked "+t+","+r),""===e.syncItem&&""===e.addressItem||jk64reportmap_userPin(e,t,r),""!==e.syncItem?($s(e.syncItem,t+","+r),jk64reportmap_refreshMap(e)):e.markerZoom&&(apex.debug(e.regionId+" pan+zoom"),e.markerPan&&e.map.panTo(a.latLng),e.map.setZoom(e.markerZoom)),""!==e.addressItem&&jk64reportmap_getAddress(e,t,r),apex.jQuery("#"+e.regionId).trigger("mapclick",{map:e.map,lat:t,lng:r})}),""!=e.geocodeItem){var r=new google.maps.Geocoder;$("#"+e.geocodeItem).change(function(){jk64reportmap_geocode(e,r)})}e.geolocate&&jk64reportmap_geolocate(e),apex.debug(e.regionId+" initMap finished"),apex.jQuery("#"+e.regionId).trigger("maploaded",{map:e.map})}function jk64reportmap_refreshMap(e){apex.debug(e.regionId+" refreshMap"),apex.jQuery("#"+e.regionId).trigger("apexbeforerefresh"),apex.server.plugin(e.ajaxIdentifier,{pageItems:e.ajaxItems},{dataType:"json",success:function(a){if(apex.debug(e.regionId+" success pData="+a.southwest.lat+","+a.southwest.lng+" "+a.northeast.lat+","+a.northeast.lng),e.map.fitBounds({south:a.southwest.lat,west:a.southwest.lng,north:a.northeast.lat,east:a.northeast.lng}),e.iw&&e.iw.close(),e.reppin){apex.debug(e.regionId+" remove all report pins");for(var t=0;t<e.reppin.length;t++)e.reppin[t].marker.setMap(null);e.reppin.delete}if(e.circles){apex.debug(e.regionId+" remove all circles");for(t=0;t<e.circles.length;t++)e.circles[t].circ.setMap(null);e.circles.delete}if(apex.debug(e.regionId+" pData.mapdata.length="+a.mapdata.length),e.mapdata=a.mapdata,e.expectData&&jk64reportmap_repPins(e),""!==e.syncItem){var r=$v(e.syncItem);if(null!==r&&r.indexOf(",")>-1){var o=r.split(",");apex.debug(e.regionId+" init from item "+o[0]+" "+o[1]),jk64reportmap_userPin(e,o[0],o[1])}}apex.jQuery("#"+e.regionId).trigger("apexafterrefresh")}}),apex.debug(e.regionId+" refreshMap finished")}