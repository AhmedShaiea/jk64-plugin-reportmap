$(function(){$.widget("jk64.reportmap",{options:{regionId:"",ajaxIdentifier:"",ajaxItems:"",pluginFilePrefix:"",expectData:!0,initialCenter:{lat:0,lng:0},minZoom:1,maxZoom:null,initialZoom:2,southwest:null,northeast:null,visualisation:"pins",mapType:"roadmap",clickZoomLevel:null,isDraggable:!1,heatmapDissipating:!1,heatmapOpacity:.6,heatmapRadius:5,panOnClick:!0,restrictCountry:"",mapStyle:"",travelMode:"DRIVING",optimizeWaypoints:!1,allowZoom:!0,allowPan:!0,gestureHandling:"auto",initFn:null,drawingModes:null,featureColor:"#cc66ff",featureColorSelected:"#ff6600",drawingPolygonHole:!1,dragDropGeoJSON:!1,noDataMessage:"No data to show",noAddressResults:"Address not found",directionsNotFound:"At least one of the origin, destination, or waypoints could not be geocoded.",directionsZeroResults:"No route could be found between the origin and destination.",parseLatLng:null,click:null,geolocate:null,gotoAddress:null,gotoPos:null,gotoPosByString:null,refresh:null,getAddressByPos:null,showDirections:null,deleteSelectedFeatures:null,deleteAllFeatures:null,loadGeoJsonString:null},parseLatLng:function(e){var t,o;(apex.debug("reportmap.parseLatLng "+e),null!=e)&&(e.indexOf(";")>-1?o=e.split(";"):e.indexOf(" ")>-1?o=e.split(" "):e.indexOf(",")>-1&&(o=e.split(",")),o&&2==o.length?(o[0]=o[0].replace(/,/g,"."),o[1]=o[1].replace(/,/g,"."),apex.debug("parsed "+o[0]+" "+o[1]),t=new google.maps.LatLng(parseFloat(o[0]),parseFloat(o[1]))):apex.debug('no LatLng found in "'+e+'"'));return t},_showMessage:function(e){apex.debug("reportmap._showMessage '"+e+"'"),this.infoWindow?this.infoWindow.close():this.infoWindow=new google.maps.InfoWindow({content:e,position:this.map.getCenter()}),this.infoWindow.open(this.map)},_hideMessage:function(){apex.debug("reportmap._hideMessage "),this.infoWindow&&this.infoWindow.close()},_pinData:function(e,t){var o={map:this.map,id:e.d,name:e.n,lat:t.lat(),lng:t.lng()};return e.f&&(e.f.a1&&(o.attr01=e.f.a1),e.f.a2&&(o.attr02=e.f.a2),e.f.a3&&(o.attr03=e.f.a3),e.f.a4&&(o.attr04=e.f.a4),e.f.a5&&(o.attr05=e.f.a5),e.f.a6&&(o.attr06=e.f.a6),e.f.a7&&(o.attr07=e.f.a7),e.f.a8&&(o.attr08=e.f.a8),e.f.a9&&(o.attr09=e.f.a9),e.f.a10&&(o.attr10=e.f.a10)),o},_marker:function(e){var t=new google.maps.Marker({map:this.map,position:new google.maps.LatLng(e.x,e.y),title:e.n,icon:e.c,label:e.l,draggable:this.options.isDraggable});t.reportmapId=e.d;var o=this;return google.maps.event.addListener(t,"click",function(){apex.debug("marker "+e.d+" clicked");var t=this.getPosition();if(e.i){o.infoWindow?o.infoWindow.close():o.infoWindow=new google.maps.InfoWindow;var a=(new DOMParser).parseFromString(e.i,"text/html");o.infoWindow.setOptions({content:a.documentElement.textContent}),o.infoWindow.open(o.map,this)}o.options.panOnClick&&o.map.panTo(t),o.options.clickZoomLevel&&o.map.setZoom(o.options.clickZoomLevel),apex.jQuery("#"+o.options.regionId).trigger("markerclick",o._pinData(e,t))}),google.maps.event.addListener(t,"dragend",function(){var t=this.getPosition();apex.debug("marker "+e.d+" moved to "+JSON.stringify(t)),apex.jQuery("#"+o.options.regionId).trigger("markerdrag",o._pinData(e,t))}),t},_showData:function(e){if(apex.debug("reportmap._showData"),e.length>0){this._hideMessage();var t=[];this.markers=[];for(var o=0;o<e.length;o++)"heatmap"==this.options.visualisation?t.push({location:new google.maps.LatLng(e[o][0],e[o][1]),weight:e[o][2]}):this.markers.push(this._marker(e[o]));switch(this.options.visualisation){case"cluster":new MarkerClusterer(this.map,this.markers,{imagePath:this.imagePrefix});break;case"heatmap":this.heatmapLayer&&(apex.debug("remove heatmapLayer"),this.heatmapLayer.setMap(null),this.heatmapLayer.delete,this.heatmapLayer=null),this.heatmapLayer=new google.maps.visualization.HeatmapLayer({data:t,map:this.map,dissipating:this.options.heatmapDissipating,opacity:this.options.heatmapOpacity,radius:this.options.heatmapRadius})}}else""!==this.options.noDataMessage&&(apex.debug("show No Data Found infowindow"),this._showMessage(this.options.noDataMessage))},_removeMarkers:function(){if(apex.debug("reportmap._removeMarkers"),this.markers){for(var e=0;e<this.markers.length;e++)this.markers[e].setMap(null);this.markers.delete}},gotoPos:function(e,t){if(apex.debug("reportmap.gotoPos",e,t),null!==e&&null!==t){var o=this.userpin?this.userpin.getPosition():new google.maps.LatLng(0,0);if(o&&e==o.lat()&&t==o.lng())apex.debug("userpin not changed");else{var a=new google.maps.LatLng(e,t);this.userpin?(apex.debug("move existing pin to new position on map",e+","+t),this.userpin.setMap(this.map),this.userpin.setPosition(a)):(apex.debug("create userpin",e+","+t),this.userpin=new google.maps.Marker({map:this.map,position:a}))}}else this.userpin&&(apex.debug("move existing pin off the map"),this.userpin.setMap(null))},gotoPosByString:function(e){apex.debug("reportmap.gotoPosByString");var t=this.parseLatLng(e);t&&this.gotoPos(t.lat(),t.lng())},gotoAddress:function(e){apex.debug("reportmap.gotoAddress");var t=new google.maps.Geocoder;this._hideMessage();var o=this;t.geocode({address:e,componentRestrictions:""!==o.options.restrictCountry?{country:o.options.restrictCountry}:{}},function(e,t){if(t===google.maps.GeocoderStatus.OK){var a=e[0].geometry.location;apex.debug("geocode ok"),o.map.setCenter(a),o.map.panTo(a),o.options.clickZoomLevel&&o.map.setZoom(o.options.clickZoomLevel),o.gotoPos(a.lat(),a.lng()),apex.debug("addressfound '"+e[0].formatted_address+"'"),apex.jQuery("#"+o.options.regionId).trigger("addressfound",{map:o.map,lat:a.lat(),lng:a.lng(),result:e[0]})}else apex.debug("Geocoder failed: "+t)})},click:function(e){apex.debug("reportmap.click");var t=this.markers.find(function(t){return t.reportmapId==e});t?new google.maps.event.trigger(t,"click"):apex.debug("id not found:"+e)},getAddressByPos:function(e,t){apex.debug("reportmap.getAddressByPos");var o=new google.maps.Geocoder;this._hideMessage();var a=this;o.geocode({location:{lat:e,lng:t}},function(o,n){if(n===google.maps.GeocoderStatus.OK)if(o[0]){apex.debug("addressfound '"+o[0].formatted_address+"'");var s=o[0].address_components;for(i=0;i<s.length;i++)apex.debug("result[0] "+s[i].types+"="+s[i].short_name+" ("+s[i].long_name+")");apex.jQuery("#"+a.options.regionId).trigger("addressfound",{map:a.map,lat:e,lng:t,result:o[0]})}else apex.debug("getAddressByPos: No results found"),a._showMessage(a.options.noAddressResults);else apex.debug("Geocoder failed: "+n)})},geolocate:function(){if(apex.debug("reportmap.geolocate"),navigator.geolocation){apex.debug("geolocate");var e=this;navigator.geolocation.getCurrentPosition(function(t){var o={lat:t.coords.latitude,lng:t.coords.longitude};e.map.panTo(o),e.options.geolocateZoom&&e.map.setZoom(e.options.geolocateZoom),apex.jQuery("#"+e.options.regionId).trigger("geolocate",{map:e.map,lat:o.lat,lng:o.lng})})}else apex.debug("browser does not support geolocation")},_directionsResponse:function(e,t){switch(apex.debug("reportmap._directionsResponse "+t),t){case google.maps.DirectionsStatus.OK:this.directionsDisplay.setDirections(e);for(var o=0,a=0,i=0,n=0;n<e.routes.length;n++){i+=e.routes[n].legs.length;for(var s=0;s<e.routes[n].legs.length;s++){var r=e.routes[n].legs[s];o+=r.distance.value,a+=r.duration.value}}apex.jQuery("#"+this.options.regionId).trigger("directions",{map:this.map,distance:o,duration:a,legs:i});break;case google.maps.DirectionsStatus.NOT_FOUND:this._showMessage(this.options.directionsNotFound);break;case google.maps.DirectionsStatus.ZERO_RESULTS:this._showMessage(this.options.directionsZeroResults);break;default:apex.debug("Directions request failed: "+t)}},showDirections:function(e,t,o){if(apex.debug("reportmap.showDirections"),this.origin=e,this.destination=t,this._hideMessage(),this.origin&&this.destination)if(this.directionsDisplay||(this.directionsDisplay=new google.maps.DirectionsRenderer,this.directionsService=new google.maps.DirectionsService,this.directionsDisplay.setMap(this.map)),this.origin=this.parseLatLng(this.origin)||this.origin,this.destination=this.parseLatLng(this.destination)||this.destination,""!==this.origin&&""!==this.destination){var a=this;this.directionsService.route({origin:this.origin,destination:this.destination,travelMode:google.maps.TravelMode[o||"DRIVING"]},function(e,t){a._directionsResponse(e,t)})}else apex.debug("No directions to show - need both origin and destination location");else apex.debug("Unable to show directions: no data, no origin/destination")},_directions:function(e){if(apex.debug("reportmap._directions "+e.length+" waypoints"),e.length>1){var t,o;this.directionsDisplay||(this.directionsDisplay=new google.maps.DirectionsRenderer,this.directionsService=new google.maps.DirectionsService,this.directionsDisplay.setMap(this.map));for(var a,i=[],n=0;n<e.length;n++)a=new google.maps.LatLng(e[n].x,e[n].y),0==n?t=a:n==e.length-1?o=a:i.push({location:a,stopover:!0});apex.debug("origin="+t+" dest="+o+" waypoints:"+i.length+" via:"+this.options.travelMode);var s=this;this.directionsService.route({origin:t,destination:o,waypoints:i,optimizeWaypoints:this.options.optimizeWaypoints,travelMode:google.maps.TravelMode[this.options.travelMode]},function(e,t){s._directionsResponse(e,t)})}else apex.debug("not enough waypoints - need at least an origin and a destination point")},deleteSelectedFeatures:function(){apex.debug("reportmap.deleteSelectedFeatures");var e=this.map.data;e.forEach(function(t){t.getProperty("isSelected")&&(apex.debug("remove",t),e.remove(t))})},deleteAllFeatures:function(){apex.debug("reportmap.deleteAllFeatures");var e=this.map.data;e.forEach(function(t){apex.debug("remove",t),e.remove(t)})},_addControl:function(e,t,o){var a=document.createElement("div"),i=document.createElement("div");i.className="reportmap-controlUI",i.title=t,a.appendChild(i);var n=document.createElement("div");n.className="reportmap-controlInner",n.style.backgroundImage=e,i.appendChild(n),i.addEventListener("click",o),this.map.controls[google.maps.ControlPosition.TOP_CENTER].push(a)},_addPoint:function(e,t){apex.debug("reportmap._addPoint",e,t),e.add(new google.maps.Data.Feature({geometry:new google.maps.Data.Point(t)}))},_addPolygon:function(e,t){apex.debug("reportmap._addPolygon",e,t),this.options.drawingPolygonHole?e.forEach(function(e){if(e.getProperty("isSelected")){var o=e.getGeometry();if("Polygon"==o.getType()){var a=o.getArray();a.push(new google.maps.Data.LinearRing(t)),e.setGeometry(new google.maps.Data.Polygon(a))}}}):e.add(new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon([t])}))},_initDrawing:function(){apex.debug("reportmap._initDrawing",this.options.drawingModes);var e=this;this.options.drawingModes.indexOf("polygon")>-1&&this._addControl("url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAB/UlEQVQ4ja2Uv2vUcBjGP89xBIcipYOICUVKKcXVIYdI5woOTuKQCCp0EBz8Azr5FyjUwUUhwUFXcRTdEgfpcIOUUookIA7SoZRyHH0cLne2lR53xXf5/njffJ7nm++bwH8OjUt20rqFWTC+DPSA7TKPfk8NjJNqXug+4gjYAv8EBZglxCVg1/bbMo/6Y4GdtAaTIM+BXhVZeHiG4DXEI8zzMo9+jAOu2d4q8+jzuGM1tW3bz4CNMo+q4X7rmOqK7b1JYABFFvaR1iU97aT1iNMC6CQVwC2kd5PAhlFmYR94jX3vtMOOpC9lFk7DGzrtIi0O120Aw03sF3FSzUlamhRmfFhm0abtvTipZso82h84FO0yj3qSVmwvAgEQ2ASGADuwj+85AALBg4a9LWlh5BCPJJH0tcjCrUkcxkl1o5n2GhMNEIjTCuxd4G6cVn1Zg6YyWKDhONQ3aND4CF2x/f0vUOxglos82gQ2J32HoxDzQhU0tyzzUdKdqUFAnNQzQK9oOqQFUOTRPuYgTqurU5sTj4E3w3XrWO4l5kmcVBcnd1fdBraLLPw1EjhRkNaz4HWhjSILd84CdZIa4KFFr8zC/ITjf4rTqg1aA2Ztf5DoFll0NMjVM8armOuS3hdZ+O3082f+YOO0viB71bA8KBSIA8wnRLc4x2d6rvgDDhXQ+Lfw2kMAAAAASUVORK5CYII=')","Subtract hole from polygon",function(t){e.options.drawingPolygonHole=!e.options.drawingPolygonHole,t.target.classList.toggle("reportmap-controlHighlight")}),this._addControl("url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAA5ElEQVQ4jc3UP0oDQRTH8U9URGSx9ASewcoz5AAL9rYexc4T2FhY6gEE0TMIQS2VFEHEgCYpfMU62cz+0SI/GPbxfr/58mYYlnXXoMEvcZD0HnGxasNWBnaEY5wl/VM847YrcB93uEn6h+G10gjzjmuUAw57AIc54AamEXzBddT3fo4/j95T1NPY8wtQ1QzjqMe4jPohFlwlmVkOCG/x3cOkxp+EV83+GVj0ARb/PeE2vmr8T+z0AZJceEN2JfC1AdI5W2r/qMs2Ey4dI6OlbN3vq8AJdiu9TXwnuQ+c473DAGugBV7oWWGmvidcAAAAAElFTkSuQmCC')","Delete selected features",function(t){e.deleteSelectedFeatures()});var t=new google.maps.drawing.DrawingManager({drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:this.options.drawingModes}});t.setMap(this.map);var o=this.map.data;google.maps.event.addListener(t,"overlaycomplete",function(t){switch(apex.debug("reportmap.overlaycomplete",t),t.type){case google.maps.drawing.OverlayType.MARKER:e._addPoint(o,t.overlay.getPosition());break;case google.maps.drawing.OverlayType.POLYGON:var a=t.overlay.getPath().getArray();e._addPolygon(o,a);break;case google.maps.drawing.OverlayType.RECTANGLE:var i=t.overlay.getBounds();a=[i.getSouthWest(),{lat:i.getSouthWest().lat(),lng:i.getNorthEast().lng()},i.getNorthEast(),{lng:i.getSouthWest().lng(),lat:i.getNorthEast().lat()}];e._addPolygon(o,a);break;case google.maps.drawing.OverlayType.POLYLINE:o.add(new google.maps.Data.Feature({geometry:new google.maps.Data.LineString(t.overlay.getPath().getArray())}));break;case google.maps.drawing.OverlayType.CIRCLE:o.add(new google.maps.Data.Feature({properties:{radius:t.overlay.getRadius()},geometry:new google.maps.Data.Point(t.overlay.getCenter())}))}t.overlay.setMap(null)}),o.setStyle(function(t){var o=e.options.featureColor,a=!1;return t.getProperty("isSelected")&&(o=e.options.featureColorSelected,a=!e.options.drawingPolygonHole),{fillColor:o,strokeColor:o,strokeWeight:1,draggable:a,editable:a}}),o.addListener("click",function(t){apex.debug("reportmap.map.data - click",t),t.feature.getProperty("isSelected")?(apex.debug("isSelected","false"),t.feature.removeProperty("isSelected"),apex.jQuery("#"+e.options.regionId).trigger("unselectfeature",{map:e.map,feature:t.feature})):(apex.debug("isSelected","true"),t.feature.setProperty("isSelected",!0),apex.jQuery("#"+e.options.regionId).trigger("selectfeature",{map:e.map,feature:t.feature}))}),o.addListener("mouseover",function(e){apex.debug("reportmap.map.data","mouseover",e),o.revertStyle(),o.overrideStyle(e.feature,{strokeWeight:4})}),o.addListener("mouseout",function(e){apex.debug("reportmap.map.data","mouseout",e),o.revertStyle()}),o.addListener("addfeature",function(t){apex.debug("reportmap.map.data","addfeature",t),apex.jQuery("#"+e.options.regionId).trigger("addfeature",{map:e.map,feature:t.feature})}),o.addListener("removefeature",function(t){apex.debug("reportmap.map.data","removefeature",t),apex.jQuery("#"+e.options.regionId).trigger("removefeature",{map:e.map,feature:t.feature})}),o.addListener("setgeometry",function(t){apex.debug("reportmap.map.data","setgeometry",t),apex.jQuery("#"+e.options.regionId).trigger("setgeometry",{map:e.map,feature:t.feature,newGeometry:t.newGeometry,oldGeometry:t.oldGeometry})}),document.addEventListener("keydown",function(t){"Delete"===t.key&&e.deleteSelectedFeatures()})},_processPoints:function(e,t,o){var a=this;e instanceof google.maps.LatLng?t.call(o,e):e instanceof google.maps.Data.Point?t.call(o,e.get()):e.getArray().forEach(function(e){a._processPoints(e,t,o)})},loadGeoJsonString:function(e){if(apex.debug("reportmap.loadGeoJsonString"),e){var t=this,o=JSON.parse(e);this.map.data.addGeoJson(o);var a=new google.maps.LatLngBounds;this.map.data.forEach(function(e){t._processPoints(e.getGeometry(),a.extend,a)}),this.map.fitBounds(a),apex.jQuery("#"+this.options.regionId).trigger("loadedgeojson",{map:this.map,geoJson:o})}},_initDragDropGeoJSON:function(){apex.debug("reportmap._initDragDropGeoJSON");var e=this,t=document.getElementById("map_"+this.options.regionId),o=document.getElementById("drop_"+this.options.regionId),a=function(e){return e.stopPropagation(),e.preventDefault(),o.style.display="block",!1};t.addEventListener("dragenter",a,!1),o.addEventListener("dragover",a,!1),o.addEventListener("dragleave",function(){o.style.display="none"},!1),o.addEventListener("drop",function(t){apex.debug("reportmap.drop",t),t.preventDefault(),t.stopPropagation(),o.style.display="none";var a=t.dataTransfer.files;if(a.length)for(var i,n=0;i=a[n];n++){var s=new FileReader;s.onload=function(t){e.loadGeoJsonString(t.target.result)},s.onerror=function(e){apex.error("reading failed")},s.readAsText(i)}else{var r=t.dataTransfer.getData("text/plain");r&&e.loadGeoJsonString(r)}return!1},!1)},_create:function(){apex.debug("reportmap._create "+this.element.prop("id")),apex.debug("options: "+JSON.stringify(this.options));var e=this,t=window.location.origin+window.location.pathname;t=t.substring(0,t.lastIndexOf("/")),this.imagePrefix=t+"/"+this.options.pluginFilePrefix+"images/m",apex.debug('this.imagePrefix="'+this.imagePrefix+'"');var o={minZoom:this.options.minZoom,maxZoom:this.options.maxZoom,zoom:this.options.initialZoom,center:this.options.initialCenter,mapTypeId:this.options.mapType,draggable:this.options.allowPan,zoomControl:this.options.allowZoom,scrollwheel:this.options.allowZoom,disableDoubleClickZoom:!this.options.allowZoom,gestureHandling:this.options.gestureHandling};this.options.mapStyle&&(o.styles=this.options.mapStyle),this.map=new google.maps.Map(document.getElementById(this.element.prop("id")),o),this.options.southwest&&this.options.northeast&&this.map.fitBounds(new google.maps.LatLngBounds(this.options.southwest,this.options.northeast)),google.maps.event.addListener(this.map,"click",function(t){apex.debug("map clicked "+JSON.stringify(t.latLng)),e.options.clickZoomLevel&&(apex.debug("pan+zoom"),e.options.panOnClick&&e.map.panTo(t.latLng),e.map.setZoom(e.options.clickZoomLevel)),apex.jQuery("#"+e.options.regionId).trigger("mapclick",{map:e.map,lat:t.latLng.lat(),lng:t.latLng.lng()})}),apex.jQuery("#"+this.options.regionId).bind("apexrefresh",function(){$("#map_"+e.options.regionId).reportmap("refresh")}),this.options.initFn&&(apex.debug("running init_javascript_code..."),this.init=this.options.initFn,this.init()),this.options.drawingModes&&this._initDrawing(),this.options.dragDropGeoJSON&&this._initDragDropGeoJSON(),this.options.expectData&&this.refresh(),apex.jQuery("#"+this.options.regionId).trigger("maploaded",{map:this.map}),apex.debug("reportmap.init finished")},refresh:function(){if(apex.debug("reportmap.refresh"),this._hideMessage(),this.options.expectData){apex.jQuery("#"+this.options.regionId).trigger("apexbeforerefresh");var e=this;apex.server.plugin(this.options.ajaxIdentifier,{pageItems:this.options.ajaxItems},{dataType:"json",success:function(t){apex.debug("success southwest="+JSON.stringify(t.southwest)+" northeast="+JSON.stringify(t.northeast)),e.map.fitBounds({south:t.southwest.lat,west:t.southwest.lng,north:t.northeast.lat,east:t.northeast.lng}),e.infoWindow&&e.infoWindow.close(),apex.debug("pData.mapdata.length="+t.mapdata.length),e._removeMarkers(),t.mapdata&&(e._showData(t.mapdata),"directions"==e.options.visualisation&&e._directions(t.mapdata)),apex.jQuery("#"+e.options.regionId).trigger("apexafterrefresh")}})}apex.debug("reportmap.refresh finished"),this._trigger("change")},_destroy:function(){this.heatmapLayer&&this.heatmapLayer.remove(),this.userpin&&delete this.userpin,this.directionsDisplay&&delete this.directionsDisplay,this.directionsService&&delete this.directionsService,this._removeMarkers(),this._hideMessage(),this.map.remove()},_setOptions:function(){this._superApply(arguments),this.refresh()},_setOption:function(e,t){this._super(e,t)}})});