/*
jk64 ReportMap v1.3 May 2020
https://github.com/jeffreykemp/jk64-plugin-reportmap
Copyright (c) 2016 - 2020 Jeffrey Kemp
Released under the MIT licence: http://opensource.org/licenses/mit-license
*/
$(function(){$.widget("jk64.reportmap",{options:{regionId:"",ajaxIdentifier:"",ajaxItems:"",pluginFilePrefix:"",expectData:!0,maximumRows:null,rowsPerBatch:null,initialCenter:{lat:0,lng:0},minZoom:1,maxZoom:null,initialZoom:2,visualisation:"pins",mapType:"roadmap",clickZoomLevel:null,isDraggable:!1,heatmapDissipating:!1,heatmapOpacity:.6,heatmapRadius:5,panOnClick:!0,restrictCountry:"",mapStyle:"",travelMode:"DRIVING",optimizeWaypoints:!1,allowZoom:!0,allowPan:!0,gestureHandling:"auto",initFn:null,markerFormatFn:null,drawingModes:null,featureColor:"#cc66ff",featureColorSelected:"#ff6600",dragDropGeoJSON:!1,autoFitBounds:!0,directionsPanel:null,spiderfier:{},spiderfyFormatFn:null,showSpinner:!0,iconBasePath:"",noDataMessage:"No data to show",noAddressResults:"Address not found",directionsNotFound:"At least one of the origin, destination, or waypoints could not be geocoded.",directionsZeroResults:"No route could be found between the origin and destination.",click:null,deleteAllFeatures:null,deleteSelectedFeatures:null,geolocate:null,getAddressByPos:null,gotoAddress:null,gotoPos:null,gotoPosByString:null,loadGeoJsonString:null,parseLatLng:null,refresh:null,showDirections:null,showInfoWindow:null},parseLatLng:function(e){var t,o;(apex.debug("reportmap.parseLatLng",e),null!=e)&&(e.indexOf(";")>-1?o=e.split(";"):e.indexOf(" ")>-1?o=e.split(" "):e.indexOf(",")>-1&&(o=e.split(",")),o&&2==o.length?(o[0]=o[0].replace(/,/g,"."),o[1]=o[1].replace(/,/g,"."),apex.debug("parsed",o),t=new google.maps.LatLng(parseFloat(o[0]),parseFloat(o[1]))):apex.debug("no LatLng found",e));return t},_showMessage:function(e){apex.debug("reportmap._showMessage",e),this.infoWindow||(this.infoWindow=new google.maps.InfoWindow),this.infoWindow.setContent(e),this.infoWindow.setPosition(this.map.getCenter()),this.infoWindow.open(this.map)},_hideMessage:function(){apex.debug("reportmap._hideMessage"),this.infoWindow&&this.infoWindow.close()},_pinData:function(e,t){var o={map:this.map,id:e.d,name:e.n,lat:t.position.lat(),lng:t.position.lng(),marker:t};return e.f&&(e.f.a1&&(o.attr01=e.f.a1),e.f.a2&&(o.attr02=e.f.a2),e.f.a3&&(o.attr03=e.f.a3),e.f.a4&&(o.attr04=e.f.a4),e.f.a5&&(o.attr05=e.f.a5),e.f.a6&&(o.attr06=e.f.a6),e.f.a7&&(o.attr07=e.f.a7),e.f.a8&&(o.attr08=e.f.a8),e.f.a9&&(o.attr09=e.f.a9),e.f.a10&&(o.attr10=e.f.a10)),o},showInfoWindow:function(e){apex.debug("reportmap.showInfoWindow",e),this.infoWindow||(this.infoWindow=new google.maps.InfoWindow);var t=(new DOMParser).parseFromString(e.info,"text/html");this.infoWindow.setContent(t.documentElement.textContent),this.infoWindow.open(this.map,e)},_newMarker:function(e){var t=this,o=new google.maps.Marker({map:this.map,position:new google.maps.LatLng(e.x,e.y),title:e.n,icon:e.c?this.options.iconBasePath+e.c:null,label:e.l,draggable:this.options.isDraggable});return o.reportmapId=e.d,o.info=e.i,this.options.markerFormatFn&&this.options.markerFormatFn(o,e.f),google.maps.event.addListener(o,"spiderfier"==this.options.visualisation?"spider_click":"click",function(){apex.debug("marker clicked",e.d);var i=this.getPosition();e.i&&t.showInfoWindow(this),t.options.panOnClick&&t.map.panTo(i),t.options.clickZoomLevel&&t.map.setZoom(t.options.clickZoomLevel),apex.jQuery("#"+t.options.regionId).trigger("markerclick",t._pinData(e,o))}),google.maps.event.addListener(o,"dragend",function(){var i=this.getPosition();apex.debug("marker moved",e.d,JSON.stringify(i)),apex.jQuery("#"+t.options.regionId).trigger("markerdrag",t._pinData(e,o))}),["pins","cluster","spiderfier"].indexOf(this.options.visualisation)>-1&&(this.idMap&&this.idMap.has(e.d)||apex.jQuery("#"+t.options.regionId).trigger("markeradded",t._pinData(e,o))),o},_spiderfy:function(){apex.debug("reportmap._spiderfy");var e=this,t=this.options.spiderfier;t.markersWontMove=!this.options.isDraggable,"keepSpiderfied"in t||(t.keepSpiderfied=!0),"basicFormatEvents"in t||(t.basicFormatEvents=!0),this.oms=new OverlappingMarkerSpiderfier(this.map,t),this.oms.addListener("format",this.options.spiderfyFormatFn||function(e,t){var o=t==OverlappingMarkerSpiderfier.markerStatus.SPIDERFIED?"https://mt.googleapis.com/vt/icon/name=icons/spotlight/spotlight-waypoint-blue.png":t==OverlappingMarkerSpiderfier.markerStatus.SPIDERFIABLE?"https://mt.googleapis.com/vt/icon/name=icons/spotlight/spotlight-waypoint-a.png":"https://mt.googleapis.com/vt/icon/name=icons/spotlight/spotlight-poi.png";e.setIcon({url:o})});for(var o=0;o<this.markers.length;o++)this.oms.addMarker(this.markers[o]);this.oms.addListener("spiderfy",function(t){apex.debug("spiderfy",t),apex.jQuery("#"+e.options.regionId).trigger("spiderfy",{map:e.map,markers:t})}),this.oms.addListener("unspiderfy",function(t){apex.debug("unspiderfy",t),apex.jQuery("#"+e.options.regionId).trigger("unspiderfy",{map:e.map,markers:t})})},_removeMarkers:function(){if(apex.debug("reportmap._removeMarkers"),this.totalRows=0,this.bounds&&this.bounds.delete,this.markers){for(var e=0;e<this.markers.length;e++)this.markers[e].setMap(null);this.markers.delete}},click:function(e){apex.debug("reportmap.click");var t=this.markers.find(function(t){return t.reportmapId==e});t?new google.maps.event.trigger(t,"click"):apex.debug("id not found",e)},gotoPos:function(e,t){if(apex.debug("reportmap.gotoPos",e,t),null!==e&&null!==t){var o=this.userpin?this.userpin.getPosition():new google.maps.LatLng(0,0);if(o&&e==o.lat()&&t==o.lng())apex.debug("userpin not changed");else{var i=new google.maps.LatLng(e,t);if(this.userpin)apex.debug("move existing pin to new position on map",i),this.userpin.setMap(this.map),this.userpin.setPosition(i);else{apex.debug("create userpin",i),this.userpin=new google.maps.Marker({map:this.map,position:i,draggable:this.options.isDraggable});var a=this;google.maps.event.addListener(this.userpin,"dragend",function(){var e=this.getPosition();apex.debug("userpin moved",JSON.stringify(e)),apex.jQuery("#"+a.options.regionId).trigger("markerdrag",{map:a.map,lat:e.lat(),lng:e.lng(),marker:this})})}}}else this.userpin&&(apex.debug("move existing pin off the map"),this.userpin.setMap(null))},gotoPosByString:function(e){apex.debug("reportmap.gotoPosByString",e);var t=this.parseLatLng(e);t&&this.gotoPos(t.lat(),t.lng())},gotoAddress:function(e){apex.debug("reportmap.gotoAddress",e);var t=new google.maps.Geocoder;this._hideMessage();var o=this;t.geocode({address:e,componentRestrictions:""!==o.options.restrictCountry?{country:o.options.restrictCountry}:{}},function(e,t){if(t===google.maps.GeocoderStatus.OK){var i=e[0].geometry.location;apex.debug("geocode ok",i),o.map.setCenter(i),o.map.panTo(i),o.options.clickZoomLevel&&o.map.setZoom(o.options.clickZoomLevel),o.gotoPos(i.lat(),i.lng()),apex.debug("addressfound",e),apex.jQuery("#"+o.options.regionId).trigger("addressfound",{map:o.map,lat:i.lat(),lng:i.lng(),result:e[0]})}else apex.debug("Geocoder failed",t)})},getAddressByPos:function(e,t){apex.debug("reportmap.getAddressByPos",e,t);var o=new google.maps.Geocoder;this._hideMessage();var i=this;o.geocode({location:{lat:e,lng:t}},function(o,a){a===google.maps.GeocoderStatus.OK?o[0]?(apex.debug("addressfound",o),apex.jQuery("#"+i.options.regionId).trigger("addressfound",{map:i.map,lat:e,lng:t,result:o[0]})):(apex.debug("getAddressByPos: No results found"),i._showMessage(i.options.noAddressResults)):apex.debug("Geocoder failed",a)})},geolocate:function(){if(apex.debug("reportmap.geolocate"),navigator.geolocation){var e=this;navigator.geolocation.getCurrentPosition(function(t){var o={lat:t.coords.latitude,lng:t.coords.longitude};e.map.panTo(o),e.options.geolocateZoom&&e.map.setZoom(e.options.geolocateZoom),apex.jQuery("#"+e.options.regionId).trigger("geolocate",{map:e.map,lat:o.lat,lng:o.lng})})}else apex.debug("browser does not support geolocation")},_directionsResponse:function(e,t){switch(apex.debug("reportmap._directionsResponse",e,t),t){case google.maps.DirectionsStatus.OK:this.directionsDisplay.setDirections(e);for(var o=0,i=0,a=0,s=0;s<e.routes.length;s++){a+=e.routes[s].legs.length;for(var n=0;n<e.routes[s].legs.length;n++){var r=e.routes[s].legs[n];o+=r.distance.value,i+=r.duration.value}}apex.jQuery("#"+this.options.regionId).trigger("directions",{map:this.map,distance:o,duration:i,legs:a,directions:e});break;case google.maps.DirectionsStatus.NOT_FOUND:this._showMessage(this.options.directionsNotFound);break;case google.maps.DirectionsStatus.ZERO_RESULTS:this._showMessage(this.options.directionsZeroResults);break;default:apex.debug("Directions request failed",t)}},showDirections:function(e,t,o){if(apex.debug("reportmap.showDirections",e,t,o),this.origin=e,this.destination=t,this._hideMessage(),this.origin&&this.destination)if(this.directionsDisplay||(this.directionsDisplay=new google.maps.DirectionsRenderer,this.directionsService=new google.maps.DirectionsService,this.directionsDisplay.setMap(this.map),this.options.directionsPanel&&this.directionsDisplay.setPanel(document.getElementById(this.options.directionsPanel))),this.origin=this.parseLatLng(this.origin)||this.origin,this.destination=this.parseLatLng(this.destination)||this.destination,""!==this.origin&&""!==this.destination){var i=this;this.directionsService.route({origin:this.origin,destination:this.destination,travelMode:google.maps.TravelMode[o||"DRIVING"]},function(e,t){i._directionsResponse(e,t)})}else apex.debug("No directions to show - need both origin and destination location");else apex.debug("Unable to show directions: no data, no origin/destination")},_directions:function(e){if(apex.debug("reportmap._directions "+e.length+" waypoints"),e.length>1){var t,o;this.directionsDisplay||(this.directionsDisplay=new google.maps.DirectionsRenderer,this.directionsService=new google.maps.DirectionsService,this.directionsDisplay.setMap(this.map),this.options.directionsPanel&&this.directionsDisplay.setPanel(document.getElementById(this.options.directionsPanel)));for(var i,a=[],s=0;s<e.length;s++)i=new google.maps.LatLng(e[s].x,e[s].y),0==s?t=i:s==e.length-1?o=i:a.push({location:i,stopover:!0});apex.debug(t,o,a,this.options.travelMode);var n=this;this.directionsService.route({origin:t,destination:o,waypoints:a,optimizeWaypoints:this.options.optimizeWaypoints,travelMode:google.maps.TravelMode[this.options.travelMode]},function(e,t){n._directionsResponse(e,t)})}else apex.debug("not enough waypoints - need at least an origin and a destination point")},deleteSelectedFeatures:function(){apex.debug("reportmap.deleteSelectedFeatures");var e=this.map.data;e.forEach(function(t){t.getProperty("isSelected")&&(apex.debug("remove",t),e.remove(t))})},deleteAllFeatures:function(){apex.debug("reportmap.deleteAllFeatures");var e=this.map.data;e.forEach(function(t){apex.debug("remove",t),e.remove(t)})},_addControl:function(e,t,o){var i=document.createElement("div"),a=document.createElement("div");a.className="reportmap-controlUI",a.title=t,i.appendChild(a);var s=document.createElement("div");s.className="reportmap-controlInner",s.style.backgroundImage=e,a.appendChild(s),a.addEventListener("click",o),this.map.controls[google.maps.ControlPosition.TOP_CENTER].push(i)},_addCheckbox:function(e,t,o){var i=document.createElement("div"),a=document.createElement("div");a.className="reportmap-controlUI",a.title=o,i.appendChild(a);var s=document.createElement("div");s.className="reportmap-controlInner",a.appendChild(s);var n=document.createElement("input");n.setAttribute("type","checkbox"),n.setAttribute("id",e+"_"+this.options.regionId),n.setAttribute("name",e),n.setAttribute("value","Y"),n.className="reportmap-controlCheckbox",n.className="reportmap-checkbox",s.appendChild(n);var r=document.createElement("label");r.setAttribute("for",e+"_"+this.options.regionId),r.innerHTML=t,r.className="reportmap-controlCheckboxLabel",s.appendChild(r),this.map.controls[google.maps.ControlPosition.TOP_CENTER].push(i)},_addPoint:function(e,t){apex.debug("reportmap._addPoint",e,t),e.add(new google.maps.Data.Feature({geometry:new google.maps.Data.Point(t)}))},_addPolygon:function(e,t){apex.debug("reportmap._addPolygon",e,t),$("#hole_"+this.options.regionId).prop("checked")?e.forEach(function(e){if(e.getProperty("isSelected")){var o=e.getGeometry();if("Polygon"==o.getType()){var i=o.getArray();i.push(new google.maps.Data.LinearRing(t)),e.setGeometry(new google.maps.Data.Polygon(i))}}}):e.add(new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon([t])}))},_initDrawing:function(){apex.debug("reportmap._initDrawing",this.options.drawingModes);var e=this;this.options.drawingModes.indexOf("polygon")>-1&&this._addCheckbox("hole","Hole","Subtract hole from polygon"),this._addControl("url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAA5ElEQVQ4jc3UP0oDQRTH8U9URGSx9ASewcoz5AAL9rYexc4T2FhY6gEE0TMIQS2VFEHEgCYpfMU62cz+0SI/GPbxfr/58mYYlnXXoMEvcZD0HnGxasNWBnaEY5wl/VM847YrcB93uEn6h+G10gjzjmuUAw57AIc54AamEXzBddT3fo4/j95T1NPY8wtQ1QzjqMe4jPohFlwlmVkOCG/x3cOkxp+EV83+GVj0ARb/PeE2vmr8T+z0AZJceEN2JfC1AdI5W2r/qMs2Ey4dI6OlbN3vq8AJdiu9TXwnuQ+c473DAGugBV7oWWGmvidcAAAAAElFTkSuQmCC')","Delete selected features",function(t){e.deleteSelectedFeatures()});var t=new google.maps.drawing.DrawingManager({drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:this.options.drawingModes}});t.setMap(this.map);var o=this.map.data;google.maps.event.addListener(t,"overlaycomplete",function(t){switch(apex.debug("reportmap.overlaycomplete",t),t.type){case google.maps.drawing.OverlayType.MARKER:e._addPoint(o,t.overlay.getPosition());break;case google.maps.drawing.OverlayType.POLYGON:var i=t.overlay.getPath().getArray();e._addPolygon(o,i);break;case google.maps.drawing.OverlayType.RECTANGLE:var a=t.overlay.getBounds();i=[a.getSouthWest(),{lat:a.getSouthWest().lat(),lng:a.getNorthEast().lng()},a.getNorthEast(),{lng:a.getSouthWest().lng(),lat:a.getNorthEast().lat()}];e._addPolygon(o,i);break;case google.maps.drawing.OverlayType.POLYLINE:o.add(new google.maps.Data.Feature({geometry:new google.maps.Data.LineString(t.overlay.getPath().getArray())}));break;case google.maps.drawing.OverlayType.CIRCLE:o.add(new google.maps.Data.Feature({properties:{radius:t.overlay.getRadius()},geometry:new google.maps.Data.Point(t.overlay.getCenter())}))}t.overlay.setMap(null)}),o.setStyle(function(t){var o=e.options.featureColor,i=!1;return t.getProperty("isSelected")&&(o=e.options.featureColorSelected,i=!$("#hole_"+e.options.regionId).prop("checked")),{fillColor:o,strokeColor:o,strokeWeight:1,draggable:i,editable:i}}),o.addListener("click",function(t){apex.debug("reportmap.map.data - click",t),t.feature.getProperty("isSelected")?(apex.debug("isSelected","false"),t.feature.removeProperty("isSelected"),apex.jQuery("#"+e.options.regionId).trigger("unselectfeature",{map:e.map,feature:t.feature})):(apex.debug("isSelected","true"),t.feature.setProperty("isSelected",!0),apex.jQuery("#"+e.options.regionId).trigger("selectfeature",{map:e.map,feature:t.feature}))}),o.addListener("mouseover",function(e){apex.debug("reportmap.map.data","mouseover",e),o.revertStyle(),o.overrideStyle(e.feature,{strokeWeight:4})}),o.addListener("mouseout",function(e){apex.debug("reportmap.map.data","mouseout",e),o.revertStyle()}),o.addListener("addfeature",function(t){apex.debug("reportmap.map.data","addfeature",t),apex.jQuery("#"+e.options.regionId).trigger("addfeature",{map:e.map,feature:t.feature})}),o.addListener("removefeature",function(t){apex.debug("reportmap.map.data","removefeature",t),apex.jQuery("#"+e.options.regionId).trigger("removefeature",{map:e.map,feature:t.feature})}),o.addListener("setgeometry",function(t){apex.debug("reportmap.map.data","setgeometry",t),apex.jQuery("#"+e.options.regionId).trigger("setgeometry",{map:e.map,feature:t.feature,newGeometry:t.newGeometry,oldGeometry:t.oldGeometry})}),document.addEventListener("keydown",function(t){"Delete"===t.key&&e.deleteSelectedFeatures()})},_processPoints:function(e,t,o){var i=this;e instanceof google.maps.LatLng?t.call(o,e):e instanceof google.maps.Data.Point?t.call(o,e.get()):e.getArray().forEach(function(e){i._processPoints(e,t,o)})},_loadGeoJson:function(e){apex.debug("_loadGeoJson",e),this.map.data.addGeoJson(e);var t=this;this.map.data.forEach(function(e){t._processPoints(e.getGeometry(),t.bounds.extend,t.bounds)}),this.options.autoFitBounds&&this.map.fitBounds(this.bounds)},loadGeoJsonString:function(e){if(apex.debug("reportmap.loadGeoJsonString",e),e){var t=JSON.parse(e);this.bounds=new google.maps.LatLngBounds,this._loadGeoJson(t),apex.jQuery("#"+this.options.regionId).trigger("loadedgeojson",{map:this.map,geoJson:t})}},_initDragDropGeoJSON:function(){apex.debug("reportmap._initDragDropGeoJSON");var e=this,t=document.getElementById("map_"+this.options.regionId),o=document.getElementById("drop_"+this.options.regionId),i=function(e){return e.stopPropagation(),e.preventDefault(),o.style.display="block",!1};t.addEventListener("dragenter",i,!1),o.addEventListener("dragover",i,!1),o.addEventListener("dragleave",function(){o.style.display="none"},!1),o.addEventListener("drop",function(t){apex.debug("reportmap.drop",t),t.preventDefault(),t.stopPropagation(),o.style.display="none";var i=t.dataTransfer.files;if(i.length)for(var a,s=0;a=i[s];s++){var n=new FileReader;n.onload=function(t){e.loadGeoJsonString(t.target.result)},n.onerror=function(e){apex.error("reading failed")},n.readAsText(a)}else{var r=t.dataTransfer.getData("text/plain");r&&e.loadGeoJsonString(r)}return!1},!1)},_initDebug:function(){apex.debug("reportmap._initDebug");var e=this,t=document.createElement("div"),o=document.createElement("div");o.className="reportmap-debugPanel",o.innerHTML="[debug mode]",t.appendChild(o),this.map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(t),google.maps.event.addListener(this.map,"mousemove",function(e){o.innerHTML="mouse position "+JSON.stringify(e.latLng)}),google.maps.event.addListener(this.map,"bounds_changed",function(t){o.innerHTML="map bounds "+JSON.stringify(e.map.getBounds())})},_getWindowPath:function(){apex.debug("reportmap._getWindowPath");var e=window.location.origin+window.location.pathname;return e.indexOf("/r/")>-1?(apex.debug("Friendly URL detected",e),e=(e=e.substring(0,e.lastIndexOf("/r/"))).substring(0,e.lastIndexOf("/"))):(apex.debug("Legacy URL detected",e),e=e.substring(0,e.lastIndexOf("/"))),apex.debug("path",e),e},_create:function(){apex.debug("reportmap._create",this.element.prop("id")),apex.debug(JSON.stringify(this.options));var e=this;this.imagePrefix=this._getWindowPath()+"/"+this.options.pluginFilePrefix+"images/m",apex.debug("imagePrefix",this.imagePrefix);var t={minZoom:this.options.minZoom,maxZoom:this.options.maxZoom,zoom:this.options.initialZoom,center:this.options.initialCenter,mapTypeId:this.options.mapType,draggable:this.options.allowPan,zoomControl:this.options.allowZoom,scrollwheel:this.options.allowZoom,disableDoubleClickZoom:!this.options.allowZoom,gestureHandling:this.options.gestureHandling};if(this.options.mapStyle&&(t.styles=this.options.mapStyle),this.map=new google.maps.Map(document.getElementById(this.element.prop("id")),t),this.options.drawingModes&&this._initDrawing(),this.options.dragDropGeoJSON&&this._initDragDropGeoJSON(),this.options.initFn&&(apex.debug("init_javascript_code running..."),this.init=this.options.initFn,this.init(),this.init.delete,apex.debug("init_javascript_code finished.")),apex.debug.getLevel()>0&&this._initDebug(),this.options.expectData&&this.refresh(),google.maps.event.addListener(this.map,"click",function(t){apex.debug("map clicked",t.latLng),e.options.clickZoomLevel&&(e.options.panOnClick&&e.map.panTo(t.latLng),e.map.setZoom(e.options.clickZoomLevel)),apex.jQuery("#"+e.options.regionId).trigger("mapclick",{map:e.map,lat:t.latLng.lat(),lng:t.latLng.lng()})}),apex.jQuery("#"+this.options.regionId).bind("apexrefresh",function(){$("#map_"+e.options.regionId).reportmap("refresh")}),apex.debug.getLevel()>0){var o='$("#map_'+e.options.regionId+'").reportmap("instance").map';apex.debug("%cThank you for using the jk64 Report Map plugin!\nTo access the Google Map object on this page, use:\n"+o+"\nMore info: https://github.com/jeffreykemp/jk64-plugin-reportmap/wiki","font-size:18px;background-color:#0076ff;color:white;line-height:30px;display:block;padding:10px;")}apex.debug("reportmap._create finished")},_afterRefresh:function(){apex.debug("_afterRefresh"),this.spinner&&(apex.debug("remove spinner"),this.spinner.remove()),apex.jQuery("#"+this.options.regionId).trigger("apexafterrefresh"),this._trigger("change")},_renderPage:function(e,t){if(apex.debug("_renderPage",t),e.mapdata){if(apex.debug("pData.mapdata length:",e.mapdata.length),e.mapdata.length>0){for(var o=0;o<e.mapdata.length;o++){var i=e.mapdata[o];if("heatmap"==this.options.visualisation)this.bounds.extend({lat:i[0],lng:i[1]}),this.weightedLocations.push({location:new google.maps.LatLng(i[0],i[1]),weight:i[2]});else if("geojson"==this.options.visualisation)this._loadGeoJson(i);else{this.bounds.extend({lat:i.x,lng:i.y});var a=this._newMarker(i);this.markers.push(a),this.newIdMap.set(i.d,o)}}this.options.autoFitBounds&&(apex.debug("fitBounds",this.bounds.getSouthWest().toJSON(),this.bounds.getNorthEast().toJSON()),this.map.fitBounds(this.bounds)),this.totalRows+=e.mapdata.length}if(this.totalRows<this.options.maximumRows&&e.mapdata.length==this.options.rowsPerBatch){apex.jQuery("#"+this.options.regionId).trigger("batchloaded",{map:this.map,countPins:this.totalRows,southwest:this.bounds.getSouthWest().toJSON(),northeast:this.bounds.getNorthEast().toJSON()}),t+=this.options.rowsPerBatch;var s=this.options.rowsPerBatch;this.totalRows+s>this.options.maximumRows&&(s=this.options.maximumRows-this.totalRows);var n=this;apex.server.plugin(this.options.ajaxIdentifier,{pageItems:this.options.ajaxItems,x01:t,x02:s},{dataType:"json",success:function(e){apex.debug("next batch received"),n._renderPage(e,t)}})}else{if(0==this.totalRows)delete this.idMap,""!==this.options.noDataMessage&&(apex.debug("show No Data Found infowindow"),this._showMessage(this.options.noDataMessage));else switch(this.options.visualisation){case"directions":this._directions(e.mapdata);break;case"cluster":new MarkerClusterer(this.map,this.markers,{imagePath:this.imagePrefix});break;case"spiderfier":this._spiderfy();break;case"heatmap":this.heatmapLayer&&(apex.debug("remove heatmapLayer"),this.heatmapLayer.setMap(null),this.heatmapLayer.delete,this.heatmapLayer=null),this.heatmapLayer=new google.maps.visualization.HeatmapLayer({data:this.weightedLocations,map:this.map,dissipating:this.options.heatmapDissipating,opacity:this.options.heatmapOpacity,radius:this.options.heatmapRadius}),this.weightedLocations.delete}apex.jQuery("#"+this.options.regionId).trigger(this.maploaded?"maprefreshed":"maploaded",{map:this.map,countPins:this.totalRows,southwest:this.bounds.getSouthWest().toJSON(),northeast:this.bounds.getNorthEast().toJSON()}),this.maploaded=!0,this.idMap=this.newIdMap,delete this.newIdMap,this._afterRefresh()}}else this._afterRefresh()},refresh:function(){if(apex.debug("reportmap.refresh"),this._hideMessage(),this.options.expectData){apex.jQuery("#"+this.options.regionId).trigger("apexbeforerefresh"),this.options.showSpinner&&(this.spinner&&this.spinner.remove(),apex.debug("show spinner"),this.spinner=apex.util.showSpinner($("#"+this.options.regionId)));var e=this,t=this.options.rowsPerBatch;this.options.maximumRows<t&&(t=this.options.maximumRows),apex.server.plugin(this.options.ajaxIdentifier,{pageItems:this.options.ajaxItems,x01:1,x02:t},{dataType:"json",success:function(t){apex.debug("first batch received"),e._removeMarkers(),e.weightedLocations=[],e.markers=[],e.bounds=new google.maps.LatLngBounds,e.newIdMap=new Map,e._renderPage(t,1)}})}else this._afterRefresh()},_destroy:function(){this.heatmapLayer&&this.heatmapLayer.remove(),this.userpin&&delete this.userpin,this.directionsDisplay&&delete this.directionsDisplay,this.directionsService&&delete this.directionsService,this._removeMarkers(),this._hideMessage(),this.map.remove()},_setOptions:function(){this._superApply(arguments),this.refresh()},_setOption:function(e,t){apex.debug(e,t),this._super(e,t)}})});