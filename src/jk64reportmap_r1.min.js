$(function(){$.widget("jk64.reportmap",{options:{regionId:"",ajaxIdentifier:"",ajaxItems:"",pluginFilePrefix:"",expectData:!0,initialCenter:{lat:0,lng:0},minZoom:1,maxZoom:null,initialZoom:2,southwest:null,northeast:null,visualisation:"pins",mapType:"roadmap",clickZoomLevel:null,isDraggable:!1,heatmapDissipating:!1,heatmapOpacity:.6,heatmapRadius:5,panOnClick:!0,restrictCountry:"",mapStyle:"",travelMode:"DRIVING",optimizeWaypoints:!1,allowZoom:!0,allowPan:!0,gestureHandling:"auto",noDataMessage:"No data to show",noAddressResults:"Address not found",directionsNotFound:"At least one of the origin, destination, or waypoints could not be geocoded.",directionsZeroResults:"No route could be found between the origin and destination.",parseLatLng:null,click:null,geolocate:null,gotoAddress:null,gotoPos:null,gotoPosByString:null,refresh:null,getAddressByPos:null,showDirections:null},parseLatLng:function(e){var o,t;(apex.debug("reportmap.parseLatLng "+e),null!=e)&&(e.indexOf(";")>-1?t=e.split(";"):e.indexOf(" ")>-1?t=e.split(" "):e.indexOf(",")>-1&&(t=e.split(",")),t&&2==t.length?(t[0]=t[0].replace(/,/g,"."),t[1]=t[1].replace(/,/g,"."),apex.debug("parsed "+t[0]+" "+t[1]),o=new google.maps.LatLng(parseFloat(t[0]),parseFloat(t[1]))):apex.debug('no LatLng found in "'+e+'"'));return o},_showMessage:function(e){apex.debug("reportmap._showMessage ");this.infoWindow?this.infoWindow.close():this.infoWindow=new google.maps.InfoWindow({content:e,position:this.map.getCenter()}),this.infoWindow.open(this.map)},_hideMessage:function(){apex.debug("reportmap._hideMessage ");this.infoWindow&&this.infoWindow.close()},_pinData:function(e,o){var t={map:this.map,id:e.d,name:e.n,lat:o.lat(),lng:o.lng()};return e.f&&(e.f.a1&&(t.attr01=e.f.a1),e.f.a2&&(t.attr02=e.f.a2),e.f.a3&&(t.attr03=e.f.a3),e.f.a4&&(t.attr04=e.f.a4),e.f.a5&&(t.attr05=e.f.a5),e.f.a6&&(t.attr06=e.f.a6),e.f.a7&&(t.attr07=e.f.a7),e.f.a8&&(t.attr08=e.f.a8),e.f.a9&&(t.attr09=e.f.a9),e.f.a10&&(t.attr10=e.f.a10)),t},_repPin:function(e){var o=this,t=new google.maps.LatLng(e.x,e.y),i=new google.maps.Marker({map:o.map,position:t,title:e.n,icon:e.c,label:e.l,draggable:o.options.isDraggable});return google.maps.event.addListener(i,"click",function(){apex.debug("repPin "+e.d+" clicked");var t=this.getPosition();e.i&&(o.iw?o.iw.close():o.iw=new google.maps.InfoWindow,o.iw.setOptions({content:e.i}),o.iw.open(o.map,this)),o.options.panOnClick&&o.map.panTo(t),o.options.clickZoomLevel&&o.map.setZoom(o.options.clickZoomLevel),apex.jQuery("#"+o.options.regionId).trigger("markerclick",o._pinData(e,t))}),google.maps.event.addListener(i,"dragend",function(){var t=this.getPosition();apex.debug("repPin "+e.d+" moved to position ("+t.lat()+","+t.lng()+")"),apex.jQuery("#"+o.options.regionId).trigger("markerdrag",o._pinData(e,t))}),o.reppin||(o.reppin=[]),o.reppin.push({id:e.d,marker:i}),i},_repPins:function(){apex.debug("reportmap._repPins");if(this.mapdata)if(this.mapdata.length>0){this._hideMessage();for(var e,o=[],t=0;t<this.mapdata.length;t++)"heatmap"==this.options.visualisation?o.push({location:new google.maps.LatLng(this.mapdata[t].x,this.mapdata[t].y),weight:this.mapdata[t].d}):(e=this._repPin(this.mapdata[t]),"cluster"==this.options.visualisation&&o.push(e));if("cluster"==this.options.visualisation)new MarkerClusterer(this.map,o,{imagePath:this.imagePrefix});else"heatmap"==this.options.visualisation&&(this.heatmapLayer&&(apex.debug("remove heatmapLayer"),this.heatmapLayer.setMap(null),this.heatmapLayer.delete,this.heatmapLayer=null),this.heatmapLayer=new google.maps.visualization.HeatmapLayer({data:o,map:this.map,dissipating:this.options.heatmapDissipating,opacity:this.options.heatmapOpacity,radius:this.options.heatmapRadius}))}else""!==this.options.noDataMessage&&(apex.debug("show No Data Found infowindow"),this._showMessage(this.options.noDataMessage))},_removePins:function(){apex.debug("reportmap._removePins");if(this.reppin){for(var e=0;e<this.reppin.length;e++)this.reppin[e].marker.setMap(null);this.reppin.delete}},gotoPos:function(e,o){apex.debug("reportmap.gotoPos");if(null!==e&&null!==o){var t=this.userpin?this.userpin.getPosition():new google.maps.LatLng(0,0);if(t&&e==t.lat()&&o==t.lng())apex.debug("userpin not changed");else{var i=new google.maps.LatLng(e,o);this.userpin?(apex.debug("move existing pin to new position on map "+e+","+o),this.userpin.setMap(this.map),this.userpin.setPosition(i)):(apex.debug("create userpin "+e+","+o),this.userpin=new google.maps.Marker({map:this.map,position:i}))}}else this.userpin&&(apex.debug("move existing pin off the map"),this.userpin.setMap(null))},gotoPosByString:function(e){apex.debug("reportmap.gotoPosByString");var o=this.parseLatLng(e);o&&this.gotoPos(o.lat(),o.lng())},gotoAddress:function(e){apex.debug("reportmap.gotoAddress");var o=this,t=new google.maps.Geocoder;o._hideMessage(),t.geocode({address:e,componentRestrictions:""!==o.options.restrictCountry?{country:o.options.restrictCountry}:{}},function(e,t){if(t===google.maps.GeocoderStatus.OK){var i=e[0].geometry.location;apex.debug("geocode ok"),o.map.setCenter(i),o.map.panTo(i),o.options.clickZoomLevel&&o.map.setZoom(o.options.clickZoomLevel),o.gotoPos(i.lat(),i.lng()),apex.debug("addressfound '"+e[0].formatted_address+"'"),apex.jQuery("#"+o.options.regionId).trigger("addressfound",{map:o.map,lat:i.lat(),lng:i.lng(),result:e[0]})}else apex.debug("Geocoder failed: "+t)})},click:function(e){apex.debug("reportmap.click");for(var o=!1,t=0;t<this.reppin.length;t++)if(this.reppin[t].id==e){new google.maps.event.trigger(this.reppin[t].marker,"click"),o=!0;break}o||apex.debug("id not found:"+e)},getAddressByPos:function(e,o){apex.debug("reportmap.getAddressByPos");var t=this,a={lat:e,lng:o},n=new google.maps.Geocoder;t._hideMessage(),n.geocode({location:a},function(a,n){if(n===google.maps.GeocoderStatus.OK)if(a[0]){apex.debug("addressfound '"+a[0].formatted_address+"'");var s=a[0].address_components;for(i=0;i<s.length;i++)apex.debug("result[0] "+s[i].types+"="+s[i].short_name+" ("+s[i].long_name+")");apex.jQuery("#"+t.options.regionId).trigger("addressfound",{map:t.map,lat:e,lng:o,result:a[0]})}else apex.debug("getAddressByPos: No results found"),t._showMessage(t.options.noAddressResults);else apex.debug("Geocoder failed: "+n)})},geolocate:function(){apex.debug("reportmap.geolocate");var e=this;navigator.geolocation?(apex.debug("geolocate"),navigator.geolocation.getCurrentPosition(function(o){var t={lat:o.coords.latitude,lng:o.coords.longitude};e.map.panTo(t),e.options.geolocateZoom&&e.map.setZoom(e.options.geolocateZoom),apex.jQuery("#"+e.options.regionId).trigger("geolocate",{map:e.map,lat:t.lat,lng:t.lng})})):apex.debug("browser does not support geolocation")},_directionsResponse:function(e,o){apex.debug("reportmap._directionsResponse "+o);if(o==google.maps.DirectionsStatus.OK){this.directionsDisplay.setDirections(e);for(var t=0,i=0,a=0,n=0;n<e.routes.length;n++){a+=e.routes[n].legs.length;for(var s=0;s<e.routes[n].legs.length;s++){var p=e.routes[n].legs[s];t+=p.distance.value,i+=p.duration.value}}apex.jQuery("#"+this.options.regionId).trigger("directions",{map:this.map,distance:t,duration:i,legs:a})}else o==google.maps.DirectionsStatus.NOT_FOUND?this._showMessage(this.options.directionsNotFound):o==google.maps.DirectionsStatus.ZERO_RESULTS?this._showMessage(this.options.directionsZeroResults):apex.debug("Directions request failed: "+o)},showDirections:function(e,o,t="DRIVING"){apex.debug("reportmap.showDirections");var i=this;i.origin=e,i.destination=o,i._hideMessage(),i.origin&&i.destination?(i.directionsDisplay||(i.directionsDisplay=new google.maps.DirectionsRenderer,i.directionsService=new google.maps.DirectionsService,i.directionsDisplay.setMap(i.map)),i.origin=i.parseLatLng(i.origin)||i.origin,i.destination=i.parseLatLng(i.destination)||i.destination,""!==i.origin&&""!==i.destination?i.directionsService.route({origin:i.origin,destination:i.destination,travelMode:google.maps.TravelMode[t]},function(e,o){i._directionsResponse(e,o)}):apex.debug("No directions to show - need both origin and destination location")):apex.debug("Unable to show directions: no data, no origin/destination")},_directions:function(){apex.debug("reportmap._directions");var e=this;if(e.mapdata)if(apex.debug("route "+e.mapdata.length+" waypoints"),e.mapdata.length>1){var o,t;e.directionsDisplay||(e.directionsDisplay=new google.maps.DirectionsRenderer,e.directionsService=new google.maps.DirectionsService,e.directionsDisplay.setMap(e.map));for(var i,a=[],n=0;n<e.mapdata.length;n++)i=new google.maps.LatLng(e.mapdata[n].x,e.mapdata[n].y),0==n?o=i:n==e.mapdata.length-1?t=i:a.push({location:i,stopover:!0});apex.debug("origin="+o+" dest="+t+" waypoints:"+a.length+" via:"+e.options.travelMode),e.directionsService.route({origin:o,destination:t,waypoints:a,optimizeWaypoints:e.options.optimizeWaypoints,travelMode:google.maps.TravelMode[e.options.travelMode]},function(o,t){e._directionsResponse(o,t)})}else apex.debug("not enough waypoints - need at least an origin and a destination point");else apex.debug("Unable to show directions: no data")},_create:function(){var e=this;apex.debug("reportmap._create "+e.element.prop("id")),apex.debug("options: "+JSON.stringify(e.options));var o=window.location.origin+window.location.pathname;o=o.substring(0,o.lastIndexOf("/")),e.imagePrefix=o+"/"+e.options.pluginFilePrefix+"images/m",apex.debug('_this.imagePrefix="'+e.imagePrefix+'"');var t={minZoom:e.options.minZoom,maxZoom:e.options.maxZoom,zoom:e.options.initialZoom,center:e.options.initialCenter,mapTypeId:e.mapType,draggable:e.options.allowPan,zoomControl:e.options.allowZoom,scrollwheel:e.options.allowZoom,disableDoubleClickZoom:!e.options.allowZoom,gestureHandling:e.options.gestureHandling};e.options.mapStyle&&(t.styles=e.options.mapStyle),e.map=new google.maps.Map(document.getElementById(e.element.prop("id")),t),e.options.southwest&&e.options.northeast&&e.map.fitBounds(new google.maps.LatLngBounds(e.options.southwest,e.options.northeast)),google.maps.event.addListener(e.map,"click",function(o){var t=o.latLng.lat(),i=o.latLng.lng();apex.debug("map clicked "+t+","+i),e.options.clickZoomLevel&&(apex.debug("pan+zoom"),e.options.panOnClick&&e.map.panTo(o.latLng),e.map.setZoom(e.options.clickZoomLevel)),apex.jQuery("#"+e.options.regionId).trigger("mapclick",{map:e.map,lat:t,lng:i})}),apex.jQuery("#"+e.options.regionId).trigger("maploaded",{map:e.map}),e.options.expectData&&e.refresh(),apex.debug("reportmap.init finished")},refresh:function(){apex.debug("reportmap.refresh");var e=this;e._hideMessage(),e.options.expectData&&(apex.jQuery("#"+e.options.regionId).trigger("apexbeforerefresh"),apex.server.plugin(e.options.ajaxIdentifier,{pageItems:e.options.ajaxItems},{dataType:"json",success:function(o){apex.debug("success pData="+o.southwest.lat+","+o.southwest.lng+" "+o.northeast.lat+","+o.northeast.lng),o.southwest.lat&&o.southwest.lng&&o.northeast.lat&&o.northeast.lng&&e.map.fitBounds({south:o.southwest.lat,west:o.southwest.lng,north:o.northeast.lat,east:o.northeast.lng}),e.iw&&e.iw.close(),e._removePins(),apex.debug("pData.mapdata.length="+o.mapdata.length),e.mapdata=o.mapdata,e._repPins(),"directions"==e.options.visualisation&&e._directions(),apex.jQuery("#"+e.options.regionId).trigger("apexafterrefresh")}})),apex.debug("reportmap.refresh finished"),e._trigger("change")},_destroy:function(){this.heatmapLayer&&this.heatmapLayer.remove(),this.iw&&this.iw.close(),this._removePins(),this.map.remove()},_setOptions:function(){this._superApply(arguments),this.refresh()},_setOption:function(e,o){this._super(e,o)}})});